

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <meta name="theme-color" content="#2f4154">
    <meta name="author" content="Lunatic sky">
    <meta name="keywords" content="">
    
        <meta name="description" content="PA1实验报告 田佳业 2013599 为了方便VSCode远程连接，采用64位Ubuntu系统完成ics2019对应的PA。因此报告中一部分代码可能会与2018版本不一致。 PA1.1 任务：实现单步执行, 打印寄存器状态, 扫描内存 开天辟地的篇章 任务 这一部分介绍了“最简单的计算机”应当具有哪些特征和功能。 思考题 计算机可以没有寄存器吗？  存储层次的产生是顺应规律的，我们会自然的把经常">
<meta property="og:type" content="article">
<meta property="og:title" content="南京大学ics2019_PA1">
<meta property="og:url" content="http://lunaticsky-tql.github.io/posts/4251/index.html">
<meta property="og:site_name" content="Lunaticsky&#39;s Blog">
<meta property="og:description" content="PA1实验报告 田佳业 2013599 为了方便VSCode远程连接，采用64位Ubuntu系统完成ics2019对应的PA。因此报告中一部分代码可能会与2018版本不一致。 PA1.1 任务：实现单步执行, 打印寄存器状态, 扫描内存 开天辟地的篇章 任务 这一部分介绍了“最简单的计算机”应当具有哪些特征和功能。 思考题 计算机可以没有寄存器吗？  存储层次的产生是顺应规律的，我们会自然的把经常">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205843099038_654_20230322090859031854_838_image-20230321183104988.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205844107732_739_20230322090859916082_681_image-20230321183847648.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205845305075_505_20230322090903021377_849_image-20230321194541159.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205846416684_863_20230322090904623223_231_image-20230321194853335.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205847482942_898_image-20230321211615894.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205849258235_907_image-20230321211811752.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205850634028_644_20230322090905518782_851_image-20230321202840329.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205851869518_327_20230322090906611356_503_image-20230321204938932.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205853446704_485_20230322090907728645_363_image-20230321205535450.png">
<meta property="article:published_time" content="2023-05-22T02:00:00.000Z">
<meta property="article:modified_time" content="2023-05-22T02:00:00.000Z">
<meta property="article:author" content="Lunatic sky">
<meta property="article:tag" content="系统设计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205843099038_654_20230322090859031854_838_image-20230321183104988.png">
    
    
    
    <title>南京大学ics2019_PA1 - Lunaticsky&#39;s Blog</title>

    
  
    <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
      
    <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />
      
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
      
        

          <!-- 主题依赖的图标库，不要自行修改 -->
          <!-- Do not modify the link that theme dependent icons -->
          
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">


            
<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


              <link  rel="stylesheet" href="/css/main.css" />

                
                  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
                    
                      <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
                        
                          

                            
                              
<link rel="stylesheet" href="/css/indeximg-hover.css">
<link rel="stylesheet" href="/css/remove-shadow.css">
<link rel="stylesheet" href="/css/zan.css">
<link rel="stylesheet" href="/css/code_fold.css">
<link rel="stylesheet" href="/css/link.css">

                                
    <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lunaticsky-tql.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"9zw4pzKGNFredmMKJc9n2JSH-gzGzoHsz","app_key":"rS2LQjQjNgLRcqtYrEVLwcSb","server_url":"https://9zw4pzkg.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
    <script  src="/js/utils.js" ></script>
    <script  src="/js/color-schema.js" ></script>
    

  

  

  

  

  

  

  
    
  


    <link  rel="stylesheet" href="/lib/font-awesome/css/all.min.css" />
    <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />
    <link  rel="stylesheet" href="/css/main.css" />

    
<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>


<header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lunatic sky‘s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/fan1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="南京大学ics2019_PA1"></span>
          
        </div>

        
          
  <div class="mt-3">
    
        
          <span class="post-meta">
            <i class="iconfont icon-date-fill" aria-hidden="true"></i>
            <time datetime="2023-05-22 10:00" pubdate>
              2023年5月22日 上午
            </time>
          </span>
          
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
              11k 字
                
      </span>
      

        

            
              
                
                  <span id="leancloud-page-views-container" class="post-meta" style="display: none">
                    <i class="iconfont icon-eye" aria-hidden="true"></i>
                    <span id="leancloud-page-views"></span>
                       次
                  </span>
                  
                    
                          
                            <!-- add a sorce code icon -->
                            <span class="post-meta mr-2">
                              <i class="iconfont icon-code"></i>
                              <!-- a link with white font color -->
                              <!-- <a target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/" style="color: #fff">Source Code</a> -->
                              <!-- https://github.com/Lunaticsky-tql/blog_article_resources/blob/main/page.title.md -->
                              <!-- construct the souce code url-->
                              
                                <a target="_blank" rel="noopener" href="https://github.com/Lunaticsky-tql/blog_article_resources/blob/main/南京大学ics2019_PA1/南京大学ics2019_PA1.md" style="color: #EA7A99">Article Resource Link</a>
                            </span>
  </div>
  
        
      </div>

      
    </div>
  </div>
</div>

</div>

</header>

<main>
    
        

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">南京大学ics2019_PA1</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="pa1实验报告">PA1实验报告</h1>
<p>田佳业 2013599</p>
<p>为了方便VSCode远程连接，采用64位Ubuntu系统完成ics2019对应的PA。因此报告中一部分代码可能会与2018版本不一致。</p>
<h2 id="pa1.1">PA1.1</h2>
<p>任务：实现单步执行, 打印寄存器状态, 扫描内存</p>
<h3 id="开天辟地的篇章">开天辟地的篇章</h3>
<h4 id="任务">任务</h4>
<p>这一部分介绍了“最简单的计算机”应当具有哪些特征和功能。</p>
<h4 id="思考题">思考题</h4>
<h6 id="计算机可以没有寄存器吗">计算机可以没有寄存器吗？</h6>
<blockquote>
<p>存储层次的产生是顺应规律的，我们会自然的把经常访问的数据放在更快的，离CPU更近(更容易获取)的存储介质上。假设计算机“不得不”没有寄存器,
我们也会让内存充当”寄存器“的作用(相比磁盘等更慢的介质)，只不过这样会使得性能变差,
因为一些需要经常使用的数据也不得不放在内存当中.</p>
</blockquote>
<h6 id="计算机的状态模型与图灵机的关系">计算机的状态模型与图灵机的关系？</h6>
<p>对于TRM来说, 是不是也有这样状态的概念呢? 具体地,
什么东西表征了TRM的状态? 在状态模型中, 执行指令和执行程序,
其本质分别是什么?</p>
<blockquote>
<p>图灵机中“状态”的概念在PA中体现在<code>NEMUState</code>这个结构中。包括<code>{ NEMU_STOP, NEMU_RUNNING, NEMU_END, NEMU_ABORT }</code>，图灵机中”格局“的概念(包括带描述，当前状态和读写头)对应到计算机就像”快照“，分别对应存储器中内容，计算机运行状态和程序计数器。图灵机中输入和转移函数都从”纸带“中获取，就像冯诺依曼体系结构，执行指令和执行程序本质上没有什么区别。</p>
</blockquote>
<h3 id="rtfsc">RTFSC</h3>
<h4 id="任务-1">任务</h4>
<h5 id="实现x86的寄存器结构体">实现x86的寄存器结构体</h5>
<p>这一部分讲义中有答案，在此不再列出代码。匿名union可以在共享内存的同时，还能以union内的名称在外部访问。这也适应了PA中”寄存器别名“的需求。</p>
<h6 id="reg_test0是如何测试你的实现的">reg_test0是如何测试你的实现的？</h6>
<blockquote>
<p>代码中的<code>assert()</code>条件是根据什么写出来的:
产生随机值到<code>sample</code>数组，让<code>cpu</code>获取，检查是否cpu能够正确获取这些值。ps:通过与1与可以取低位。</p>
</blockquote>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-xlkggylmngiym5"></i><span>c</span><div class="collapse show" id="collapse-xlkggylmngiym5"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">reg_test</span><span class="hljs-params">()</span> {
  <span class="hljs-comment">//init random seed</span>
  srand(time(<span class="hljs-number">0</span>));
  <span class="hljs-type">uint32_t</span> sample[<span class="hljs-number">8</span>];
  <span class="hljs-comment">//generate random values for eip</span>
  <span class="hljs-type">uint32_t</span> eip_sample = rand();
  cpu.eip = eip_sample;

  <span class="hljs-type">int</span> i;
  <span class="hljs-comment">//generate random values for general registers</span>
  <span class="hljs-keyword">for</span> (i = R_EAX; i &lt;= R_EDI; i ++) {
    sample[i] = rand();
    reg_l(i) = sample[i];
    <span class="hljs-comment">// test whether reg_w() can normally return the low 16 bits of the general register</span>
    assert(reg_w(i) == (sample[i] &amp; <span class="hljs-number">0xffff</span>));
  }
    <span class="hljs-comment">// test whether reg_w() can normally return the low 8 bits of the general register</span>
  assert(reg_b(R_AL) == (sample[R_EAX] &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_AH) == ((sample[R_EAX] &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_BL) == (sample[R_EBX] &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_BH) == ((sample[R_EBX] &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_CL) == (sample[R_ECX] &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_CH) == ((sample[R_ECX] &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_DL) == (sample[R_EDX] &amp; <span class="hljs-number">0xff</span>));
  assert(reg_b(R_DH) == ((sample[R_EDX] &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>));
  <span class="hljs-comment">// test the alias of general registers</span>
  assert(sample[R_EAX] == cpu.eax);
  assert(sample[R_ECX] == cpu.ecx);
  assert(sample[R_EDX] == cpu.edx);
  assert(sample[R_EBX] == cpu.ebx);
  assert(sample[R_ESP] == cpu.esp);
  assert(sample[R_EBP] == cpu.ebp);
  assert(sample[R_ESI] == cpu.esi);
  assert(sample[R_EDI] == cpu.edi);

  assert(eip_sample == cpu.eip);
}</code></pre></div></div>
<h6 id="究竟要执行多久">究竟要执行多久？</h6>
<p>在<code>cmd_c()</code>函数中,
调用<code>cpu_exec()</code>的时候传入了参数<code>-1</code>的含义？</p>
<blockquote>
<p><code>-1</code>的十六进制表示就是<code>0xffffffff</code>,
然后这是一个无符号的类型, 所以是最大的无符号数,
所以在正常情况下(<code>nemu_state.state == NEMU_RUNNING</code>)会一直执行下去。在for循环内，2018版的PA为<code>exec_wrapper</code>，2019PA为<code>exec_once</code>就做了图灵机章节中所述三件基本事情：取指，执行，更新PC。</p>
</blockquote>
<h6 id="潜在的威胁">潜在的威胁</h6>
<p>"调用<code>cpu_exec()</code>的时候传入了参数<code>-1</code>",
这一做法属于未定义行为吗? 请查阅C99手册确认你的想法.</p>
<blockquote>
<p>C99的文档并不太好找，但猜测既然这么问，很可能是属于未定义行为。</p>
</blockquote>
<h6 id="温故而知新">温故而知新</h6>
<p><code>opcode_table</code>到底是个什么类型的数组?</p>
<blockquote>
<p><code>OpcodeEntry</code>类型。定义如下：</p>
</blockquote>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-zbewm9lmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-zbewm9lmngiym5"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
  DHelper decode;
  EHelper execute;
  <span class="hljs-type">int</span> width;
} OpcodeEntry;</code></pre></div></div>
<h6 id="有始有终">有始有终</h6>
<p>对于GNU/Linux上的一个程序, 怎么样才算开始? 怎么样才算是结束?
对于在NEMU中运行的程序, 问题的答案又是什么呢?</p>
<blockquote>
<p>NEMU中为什么要有<code>nemu_trap</code>? 为什么要有monitor?</p>
<p>在GNU/Linux上的一个C程序，main函数只是充当一个”入口“的作用，在main函数调用之前，为了保证程序可以顺利进行，要先初始化进程执行环境，如堆分配初始化、线程子系统等，如果是C++，C++的全局对象构造函数也是这一时期被执行的，全局析构函数是main之后执行的。</p>
<p>Linux一般程序的入口是__start函数，有两个段：</p>
<ul>
<li>.init段：进程的初始化代码，一个程序开始运行时，在main函数调用之前，会先运行.init段中的代码。</li>
<li>.fini段：进程终止代码，当main函数正常退出后，glibc会安排执行该段代码。</li>
</ul>
<p>在NEMU中<code>nemu_trap</code>指令,
就是让程序来结束运行的。定义一个结束程序的API,
比如<code>void halt()</code>,
它对不同架构上程序的不同结束方式进行了抽象:
程序只要调用<code>halt()</code>就可以结束运行。</p>
</blockquote>
<h3 id="基础设施">基础设施</h3>
<h4 id="任务-2">任务</h4>
<p>这一部分主要是需要实现一个简易调试器，在<code>nemu/src/monitor/debug/ui.c</code>中仿照给出的命令可以比较容易的完成，并没有遇到比较大的困难。</p>
<h5 id="单步执行">单步执行</h5>
<p>如果给出参数，执行指定步数，没有，执行一步。读取<code>si</code>后面的数字可以用<code>*args</code>参数，当然根据文档提示也可以用<code>strtok</code>。下面两种实现方式都是可以的。注意用<code>strtok</code>时由于在<code>ui_mainloop</code>中已经传入的<code>str</code>，根据<code>strtok</code>是使用方式后续第一和参数应当使用<code>NULL</code>。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-wtvcyzlmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-wtvcyzlmngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">cmd_si</span><span class="hljs-params">(<span class="hljs-type">char</span> *args)</span> </span>{
  <span class="hljs-type">int</span> step = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">sscanf</span>(args, <span class="hljs-string">"%d"</span>, &amp;step);
  }
  <span class="hljs-built_in">cpu_exec</span>(step);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div></div>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-gie2bglmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-gie2bglmngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">cmd_si</span><span class="hljs-params">(<span class="hljs-type">char</span> *args)</span></span>{
  <span class="hljs-type">char</span> * step_c= <span class="hljs-built_in">strtok</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">" "</span>);
  <span class="hljs-keyword">if</span>(step_c == <span class="hljs-literal">NULL</span>){
    <span class="hljs-built_in">cpu_exec</span>(<span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">else</span>{
    <span class="hljs-type">int</span> step = <span class="hljs-built_in">atoi</span>(step_c);
    <span class="hljs-built_in">cpu_exec</span>(step);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div></div>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205843099038_654_20230322090859031854_838_image-20230321183104988.png" srcset="/img/loading.gif" lazyload alt="image-20230321183104988">
<figcaption aria-hidden="true">image-20230321183104988</figcaption>
</figure>
<h5 id="打印寄存器">打印寄存器</h5>
<p>201版本的PA针对不同体系结构的寄存器读取做了抽象，因此在<code>cmd_info</code>中调用<code>isa_reg_display</code>，具体工作在这个函数中进行。</p>
<p>对于x86实现如下，仿照了gdb的格式，输出寄存器，二进制和十进制值。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-gw00pjlmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-gw00pjlmngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">isa_reg_display</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-comment">// it works like the gdb command "info reg"</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = R_EAX; i &lt;= R_EDI; i++)
  {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"$%s\t0x%08x\t%d\n"</span>, regsl[i], <span class="hljs-built_in">reg_l</span>(i), <span class="hljs-built_in">reg_l</span>(i));
  }
  <span class="hljs-comment">//print pc</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"$eip\t0x%08x\n"</span>, cpu.pc);
}</code></pre></div></div>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205844107732_739_20230322090859916082_681_image-20230321183847648.png" srcset="/img/loading.gif" lazyload alt="image-20230321183847648">
<figcaption aria-hidden="true">image-20230321183847648</figcaption>
</figure>
<h4 id="实现扫描内存">实现扫描内存</h4>
<p>这一部分也比较容易，使用用<code>sscanf</code>读取参数，并调用<code>isa_vaddr_read</code>进行读取即可。代码不再赘述。</p>
<h4 id="问题">问题</h4>
<h6 id="基础设施-提高项目开发的效率">基础设施-提高项目开发的效率</h6>
<p>现在我们来假设我们没有提供一键编译的功能,你需要通过手动键入 gcc
命令的方式来编译源文件:假 设你手动输入一条 gcc 命令需要 10
秒的时间(你还需要输入很多编译选项,能用 10 秒输入完已经是非常快的了), 而
NEMU 工程下有 30 个源文件,为了编译出 NEMU
的可执行文件,你需要花费多少时间?然而你还需要在开发 NEMU
的过程中不断进行编译,假设你需要编译 500 次 NEMU 才能完成
PA,一学期下来,你仅仅花在键入编译命令上的时间有多少?</p>
<p>需要15000s的时间。因此虽然make的语法显得非常晦涩，但和其他GNU工具链一样，当充分熟悉之后可以极大提高开发效率。</p>
<h6 id="如何测试字符串处理函数">如何测试字符串处理函数？</h6>
<p>你可以考虑一下, 你会如何测试自己编写的字符串处理函数?</p>
<blockquote>
<p>可以像表达式求值一样的思路。如果有已知的库函数能够解决问题，可以通过编写测试用例对照测试。如果没有，可以尝试使用不同的方式实现，进行对照。但这会受到已有思路的限制。当然，最基础的断言，打断点等调试手段也会有帮助，</p>
</blockquote>
<h6 id="好像有点不对劲">好像有点不对劲</h6>
<p>和默认镜像进行对比的时候, 扫描内存的结果貌似有点不太一样.
你知道这是为什么吗?</p>
<blockquote>
<p>2019版的这个问题，现在还不是很明白，不过猜测与内存地址转换有关系。</p>
</blockquote>
<h2 id="pa1.2">PA1.2</h2>
<h3 id="表达式求值">表达式求值</h3>
<h4 id="任务-3">任务</h4>
<p>完成表达式求值的功能。在编译原理的词法分析部分已经有所基础，但在实际编码的过程中尽管也查阅的网上很多资料，写起来也并不太顺手，也是整个实验中耗时最长的一部分。不过有前人的铺垫结合自己的的理解，测试的过程总体还算顺利，所幸没有遇到太奇怪的bug。</p>
<h5 id="测试程序">测试程序</h5>
<p>在写这一周目部分代码之前先做的是测试部分(==后面发现2018的PA并没有要求实现这一部分(捂脸))。测试部分如文档所述非常巧妙，生成随机的数字和操作符，然后写了一个模版c程序把表达式通过<code>sprintf</code>”嵌入“到代码中最后使用系统命令编译运行这个C程序。这一部分可以详见<code>nemu/tools/gen-expr/gen-expr.c</code>部分。不过递归的实现还有些小问题，比如连续生成数字或运算结果过大导致结果溢出int范围等。最后还是从里面找了一些正常的表达式手动输入进行测试的。</p>
<h5 id="添加正则">添加正则</h5>
<p>编译原理课这一块已经很熟悉了。其中寄存器可以采用宽松验证和准确验证。对于debugger来说准确验证更好，还是尽量避免未知行为的发生。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-j485ialmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-j485ialmngiym5"><pre><code class="hljs c++"><span class="hljs-comment">// {"\\$[a-zA-Z]+",TK_REG}, //register</span>
<span class="hljs-comment">// more specific</span>
{<span class="hljs-string">"\\$(e[abcd]x|e[sbi]p|e[ds]i|[abcd]x|[sb]p|[ds]i)"</span>, TK_REG}};</code></pre></div></div>
<h5 id="make_token">make_token</h5>
<p>添加完规则后，框架中已经给出了<code>match</code>的过程，我们只需要把匹配到的<code>token</code>信息保存下来即可。</p>
<h5 id="预处理">预处理</h5>
<p>在进入求值部分之前，为了区分负数和减号以及解引用和乘号，按照讲义的思路先过一遍预处理。一个坑是判断是数字的时候不要忘了有十六进制数的存在。这个小问题是写<code>eval</code>函数处理十六进制数的时候想起来的。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-sbpodwlmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-sbpodwlmngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">expr</span><span class="hljs-params">(<span class="hljs-type">char</span> *e, <span class="hljs-type">bool</span> *success)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">make_token</span>(e))
  {
    *success = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Insert codes to evaluate the expression. */</span>
  <span class="hljs-comment">// handle the deref and neg at the first</span>
  <span class="hljs-comment">// because if the * or - is at the first, it must be unary operator</span>
  <span class="hljs-comment">// pre-processing</span>
  <span class="hljs-keyword">if</span> (tokens[<span class="hljs-number">0</span>].type == <span class="hljs-string">'-'</span>)
  {
    tokens[<span class="hljs-number">0</span>].type = TK_DEREF;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tokens[<span class="hljs-number">0</span>].type == <span class="hljs-string">'*'</span>)
  {
    tokens[<span class="hljs-number">0</span>].type = TK_DEREF;
  }
  <span class="hljs-comment">// parse the rest tokens</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; nr_token; i++)
  {
    <span class="hljs-keyword">if</span> (tokens[i].type == <span class="hljs-string">'-'</span>)
    {
      <span class="hljs-keyword">if</span> (tokens[i - <span class="hljs-number">1</span>].type != TK_NUM &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != TK_HEXNUM &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != TK_REG &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != <span class="hljs-string">')'</span>)
      {
        tokens[i].type = TK_NEG;
      }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tokens[i].type == <span class="hljs-string">'*'</span>)
    {
      <span class="hljs-keyword">if</span> (tokens[i - <span class="hljs-number">1</span>].type != TK_NUM &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != TK_HEXNUM &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != TK_REG &amp;&amp; tokens[i - <span class="hljs-number">1</span>].type != <span class="hljs-string">')'</span>)
      {
        tokens[i].type = TK_DEREF;
      }
    }
  }
  *success = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(<span class="hljs-number">0</span>, nr_token - <span class="hljs-number">1</span>);
  <span class="hljs-comment">// return 0;</span>
}</code></pre></div></div>
<h5 id="eval递归求值">eval递归求值</h5>
<p>这一部分是这个任务的核心，讲义中也给出了实现的思路。我的实现代码如下：</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-55m6sxlmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-55m6sxlmngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">eval</span><span class="hljs-params">(<span class="hljs-type">int</span> p, <span class="hljs-type">int</span> q)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-keyword">if</span> (p &gt; q)
  {
    <span class="hljs-comment">/* Bad expression */</span>
    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"Bad expression"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p == q)
  {
    <span class="hljs-keyword">switch</span> (tokens[p].type)
    {
    <span class="hljs-keyword">case</span> TK_NUM:
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">atoi</span>(tokens[p].str);
    <span class="hljs-keyword">case</span> TK_HEXNUM:
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">strtol</span>(tokens[p].str, <span class="hljs-literal">NULL</span>, <span class="hljs-number">16</span>);
    <span class="hljs-keyword">case</span> TK_REG:;
      <span class="hljs-comment">// remove the $ in the string</span>
      <span class="hljs-type">char</span> *reg_name = tokens[p].str + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = R_EAX; i &lt; R_EDI; i++)
      {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(reg_name, m_regsl[i]) == <span class="hljs-number">0</span>)
        {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">reg_l</span>(i);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(reg_name, m_regsw[i]) == <span class="hljs-number">0</span>)
        {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">reg_w</span>(i);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(reg_name, m_regsb[i]) == <span class="hljs-number">0</span>)
        {
          <span class="hljs-keyword">return</span> <span class="hljs-built_in">reg_b</span>(i);
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(tokens[p].str, <span class="hljs-string">"$eip"</span>) == <span class="hljs-number">0</span>)
      {
        <span class="hljs-keyword">return</span> cpu.pc;
      }
      <span class="hljs-keyword">else</span>
      {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error in TK_REG in eval()\n"</span>);
        <span class="hljs-built_in">assert</span>(<span class="hljs-number">0</span>);
      }
    }
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">check_parentheses</span>(p, q) == <span class="hljs-literal">true</span>)
  {
    <span class="hljs-comment">/* The expression is surrounded by a matched pair of parentheses.</span>
<span class="hljs-comment">     * If that is the case, just throw away the parentheses.</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(p + <span class="hljs-number">1</span>, q - <span class="hljs-number">1</span>);
  }
  <span class="hljs-keyword">else</span>
  {
    <span class="hljs-type">int</span> op_pos = <span class="hljs-built_in">get_domin_op_pos</span>(p, q);
    <span class="hljs-comment">// printf("op_pos=%d\n", op_pos);</span>
    <span class="hljs-type">uint32_t</span> val2 = <span class="hljs-built_in">eval</span>(op_pos + <span class="hljs-number">1</span>, q);
    <span class="hljs-comment">// printf("p=%d\n", p);</span>
    <span class="hljs-keyword">if</span> (op_pos == p)
    {
      <span class="hljs-keyword">switch</span> (tokens[op_pos].type)
      {
      <span class="hljs-keyword">case</span> TK_DEREF:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">vaddr_read</span>(val2, <span class="hljs-number">4</span>);
      <span class="hljs-keyword">case</span> TK_NEG:
        <span class="hljs-keyword">return</span> -val2;
      <span class="hljs-keyword">case</span> TK_NOT:
        <span class="hljs-keyword">return</span> !val2;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unrecognized single operator in eval()"</span>);
      }
    }
    <span class="hljs-type">uint32_t</span> val1 = <span class="hljs-built_in">eval</span>(p, op_pos - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">switch</span> (tokens[op_pos].type)
    {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'+'</span>:
      <span class="hljs-keyword">return</span> val1 + val2;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'-'</span>:
      <span class="hljs-keyword">return</span> val1 - val2;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'*'</span>:
      <span class="hljs-keyword">return</span> val1 * val2;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'/'</span>:
      <span class="hljs-keyword">return</span> val1 / val2;
    <span class="hljs-keyword">case</span> TK_AND:
      <span class="hljs-keyword">return</span> val1 &amp;&amp; val2;
    <span class="hljs-keyword">case</span> TK_OR:
      <span class="hljs-keyword">return</span> val1 || val2;
    <span class="hljs-keyword">case</span> TK_EQ:
      <span class="hljs-keyword">return</span> val1 == val2;
    <span class="hljs-keyword">case</span> TK_NEQ:
      <span class="hljs-keyword">return</span> val1 != val2;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unrecognized operator in eval()"</span>);
    }
  }
  <span class="hljs-comment">// should not reach here, but if not return, gcc will complain</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}</code></pre></div></div>
<p>最后求值的时候，<code>if (op_pos == p)</code>条件可以使单目运算优先被处理，这一点也是参照了网上的代码才想到。</p>
<p>其中<code>check_parentheses(p, q)</code>部分的实现不复杂，扫一遍就可以了。先判断左右两端是否被括号包围，再判断里面的括号是否匹配。这一部分代码较简单，不再赘述。</p>
<p>获取优先级部分比较复杂，又回到了被编译原理支配的痛苦。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-tnt03almngiym5"></i><span>c++</span><div class="collapse show" id="collapse-tnt03almngiym5"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get_domin_op_pos</span><span class="hljs-params">(<span class="hljs-type">int</span> p, <span class="hljs-type">int</span> q)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-type">int</span> bracket_cnt = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// level 0: * - !</span>
  <span class="hljs-comment">// level 1: * /</span>
  <span class="hljs-comment">// level 2: + -</span>
  <span class="hljs-comment">// level 3: &amp;&amp;</span>
  <span class="hljs-comment">// level 4: ||</span>
  <span class="hljs-comment">// level 5: == !=</span>
  <span class="hljs-type">int</span> levels[<span class="hljs-number">6</span>] = {<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>};
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = p; i &lt; q; i++)
  {
    <span class="hljs-keyword">if</span> (tokens[i].type == <span class="hljs-string">'('</span>)
    {
      bracket_cnt++;
    }
    <span class="hljs-keyword">if</span> (tokens[i].type == <span class="hljs-string">')'</span>)
    {
      bracket_cnt--;
    }
    <span class="hljs-keyword">if</span> (bracket_cnt == <span class="hljs-number">0</span>)
    {
      <span class="hljs-keyword">switch</span> (tokens[i].type)
      {
      <span class="hljs-keyword">case</span> TK_DEREF:
      <span class="hljs-keyword">case</span> TK_NEG:
      <span class="hljs-keyword">case</span> TK_NOT:
        <span class="hljs-keyword">if</span> (levels[<span class="hljs-number">0</span>] == <span class="hljs-number">-1</span>)
        {
          levels[<span class="hljs-number">0</span>] = i;
        }
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'*'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'/'</span>:
        levels[<span class="hljs-number">1</span>] = i;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'+'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'-'</span>:
        levels[<span class="hljs-number">2</span>] = i;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> TK_AND:
        levels[<span class="hljs-number">3</span>] = i;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> TK_OR:
        levels[<span class="hljs-number">4</span>] = i;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> TK_EQ:
      <span class="hljs-keyword">case</span> TK_NEQ:
        levels[<span class="hljs-number">5</span>] = i;
        <span class="hljs-keyword">break</span>;
      }
    }
  }</code></pre></div></div>
<p>一个坑是注意到讲义中提到<strong>出现在一对括号中的token不是主运算符</strong>，因此一定要确保只对括号外的运算符判断优先级即可。优先级参照C++的优先级表分成了六个等级，依次扫描即可。</p>
<p>接下来for循环遍历的过程自然地返回了存在的最高优先级运算符的位置。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-xjqk04lmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-xjqk04lmngiym5"><pre><code class="hljs c++">  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++)
  {
    <span class="hljs-keyword">if</span> (levels[i] != <span class="hljs-number">-1</span>)
    {
      <span class="hljs-keyword">return</span> levels[i];
    }
  }
  <span class="hljs-comment">// if no operator found</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error:no operator found in get_domin_op_pos\n"</span>);
  <span class="hljs-built_in">panic</span>(<span class="hljs-string">"p=%d,q=%d in get_domin_op_pos() where got no token"</span>, p, q);
}</code></pre></div></div>
<p>当然最后需要在<code>ui.c</code>加入表达式求值的指令。</p>
<p>实现效果：</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205845305075_505_20230322090903021377_849_image-20230321194541159.png" srcset="/img/loading.gif" lazyload alt="image-20230321194541159">
<figcaption aria-hidden="true">image-20230321194541159</figcaption>
</figure>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205846416684_863_20230322090904623223_231_image-20230321194853335.png" srcset="/img/loading.gif" lazyload alt="image-20230321194853335">
<figcaption aria-hidden="true">image-20230321194853335</figcaption>
</figure>
<h4 id="感想">感想</h4>
<p>在表达式求值的实验中确实感受到了基本调试工具和手段的重要性。首先gcc开启<code>--Wall</code>和<code>-Werror</code>能够杜绝绝大多数“手误”(第一次完整实现完表达式求值的时候错误爆满屏..)，同时不同位置的<code>assert</code>也便于查看问题出现的位置。</p>
<h2 id="pa1.3">PA1.3</h2>
<h3 id="监视点">监视点</h3>
<h4 id="任务-4">任务</h4>
<p>这一部分相比前两部分要简单很多。主要是链表的基本操作，操作系统，编译原理中也经过多次练习。主要是需要考虑清楚清楚是“头插法”还是“尾插法”。</p>
<p>先在nemu/include/monitor/watchpoint.h中完成对结构体
的补充和函数的定义。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-nkdl7wlmngiym5"></i><span>c++</span><div class="collapse show" id="collapse-nkdl7wlmngiym5"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">watchpoint</span>
{
  <span class="hljs-type">int</span> NO;
  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">watchpoint</span> *next;

  <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Add more members if necessary */</span>
  <span class="hljs-type">char</span> expr[<span class="hljs-number">32</span>];
  <span class="hljs-type">uint32_t</span> value;

} WP;</code></pre></div></div>
<p>当我们需要打印断点信息的时候需要知道表达式和具体值。</p>
<p>添加监视点需要从free链表中取一个结点给head
链表，且将表达式、节点值赋给它，最后返回该节点的编号。删除监视点是遍历head链表直到找出对应NO的结点，从head中删除，添加到free链表中。同时
修改类型、表达式、值。代码参见<code>nemu/src/monitor/debug/watchpoint.c</code>，不再赘述。</p>
<h4 id="问题-1">问题</h4>
<p>下面的问题的答案都主要来自于讲义中提供的文章，这篇文章比较深入的介绍了x86
int3指令的工作方式。</p>
<h6 id="一点也不能长">一点也不能长?</h6>
<p>我们知道 int3 指令不带任何操作数,操作码为 1 个字节,因此指令的长度是 1
个字节.这是必须的吗?假设有 一种 x86 体系结构的变种 my-x86,除了 int3
指令的长度变成了 2 个字节之外,其余指令和 x86 相同.在 my-x86
中,文章中的断点机制还可以正常工作吗?为什么?</p>
<blockquote>
<p>Intel Mannual 原文中提到：</p>
<blockquote>
<p>This one byte form is valuable because it can be used to replace the
first byte of any instruction with a breakpoint, including other one
byte instructions, without over-writing other code</p>
</blockquote>
<p>第二个问题的答案是不能。</p>
<p>文章中还给出了这个例子：</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-w01aaolmngiym5"></i><span>assembly</span><div class="collapse show" id="collapse-w01aaolmngiym5"><pre><code class="hljs assembly">   .. some code ..
   jz    foo
   dec   eax
&gt;foo:
   call  bar
   .. some code ..
</code></pre></div></div>
<p>假设我们想在dec-eax上放置一个断点。这恰好是一条单字节指令（操作码为0x48）。如果替换断点指令的长度超过1字节，将被迫覆盖下一条指令（调用）的一部分，这将使其混乱，并可能产生完全无效的内容。并且我们不确定<code>jz foo</code>会不会跳转。在不停止dec-eax的情况下，CPU将直接执行其后的无效指令。</p>
<p>由于1字节是x86上指令能得到的最短字节，我们保证只有我们想要中断的指令才会被更改。</p>
</blockquote>
<h6 id="随心所欲的断点">随心所欲"的断点</h6>
<p>在x86中由于是使用int3中断触发的断点，如果在x86架构gdb中将断点设置在指令的非首字节（中间或末尾），根据gdb的工作原理，会将目标地址的第一个字节替换为int
3指令，然后触发断点后再换回去，将被跟踪进程的指令指针回滚一位。(这也就是指导书中说的“偷龙转凤”)因此，这时候回滚的位置可能并不符合预期。事实上gdb在这种情况下也会报错。</p>
<h6 id="nemu的前世今生">NEMU的前世今生</h6>
<p>NEMU是通过监视点来模拟断点的，而gdbz正如上文所示是通过创建<code>ptrace</code>进程命中操作系统的<code>int3</code>中断完成的。</p>
<h2 id="i386手册">I386手册</h2>
<h6 id="尝试通过目录定位关注的问题">尝试通过目录定位关注的问题</h6>
<p>假设你现在需要了解一个叫 selector 的概念,请通过 i386
手册的目录确定你需要阅读手册中的哪些地方.</p>
<p>可以通过搜索解决问题。关于selector的详细阐述在内存管理部分，</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205847482942_898_image-20230321211615894.png" srcset="/img/loading.gif" lazyload alt="image-20230321211615894">
<figcaption aria-hidden="true">image-20230321211615894</figcaption>
</figure>
<p>点进去就可以看到段选择子的格式。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205849258235_907_image-20230321211811752.png" srcset="/img/loading.gif" lazyload alt="image-20230321211811752">
<figcaption aria-hidden="true">image-20230321211811752</figcaption>
</figure>
<h2 id="必答题">必答题</h2>
<p>一、</p>
<p>1、EFLAGS 寄存器中的 CF 位是什么意思?</p>
<p>CF是进位标志，在最高位发生进位或借位后将CF位置1，否则置0。</p>
<p>2、ModR/M 字节是什么?</p>
<p>ModR/M由Mod，Reg/Opcode，R/M三部分组成。Mod是前两位，用来寄存器寻址和内存寻
址;Reg/Opcode是中间三位，Reg代表使用的寄存器，Opcode则是对group的Opcode进行补
充;R/M为最后三位，与Mod结合起来可以得到8个寄存器和24个内存寻址。</p>
<p>3、mov 指令的具体格式是怎么样的? 格式是DEST ← SRC。</p>
<p>二、</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-twmz2dlmngiym5"></i><span>shell</span><div class="collapse show" id="collapse-twmz2dlmngiym5"><pre><code class="hljs shell">find . -name "*[.h/.c]" | xargs wc -l</code></pre></div></div>
<p>利用正则表达式，可以如下方式获取非空行代码行数</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-twwd40lmngiym5"></i><span>shell</span><div class="collapse show" id="collapse-twwd40lmngiym5"><pre><code class="hljs shell">find . -name "*[.h/.c]" | xargs grep "^." | wc -l</code></pre></div></div>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205850634028_644_20230322090905518782_851_image-20230321202840329.png" srcset="/img/loading.gif" lazyload alt="image-20230321202840329">
<figcaption aria-hidden="true">image-20230321202840329</figcaption>
</figure>
<p><code>git checkout</code>到原来的状态后结果如下：</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205851869518_327_20230322090906611356_503_image-20230321204938932.png" srcset="/img/loading.gif" lazyload alt="image-20230321204938932">
<figcaption aria-hidden="true">image-20230321204938932</figcaption>
</figure>
<p>可以看到这次PA总共写了523行代码。</p>
<p>三、</p>
<p>-Wall
打开所有警告，使用GCC进行编译后产生尽可能多的警告信息，取消编译操作，打印
编译时所有错误或警告信息。</p>
<p>-Werror 要求GCC将所有的警告当成错误进行处理，取消编译操作。</p>
<p>使用-Wall和-Werror就是为了找出所有存在的警告，从而尽可能地避免程序运行出错。</p>
<p>这次实验的很多错误的发现都有这个的帮助。不过有时候gcc的检查也会显得过于严格。比如下面<code>eval</code>函数虽然已经包含了所有分支的处理，但最后还是要求我们return一个值。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA1/20230828205853446704_485_20230322090907728645_363_image-20230321205535450.png" srcset="/img/loading.gif" lazyload alt="image-20230321205535450">
<figcaption aria-hidden="true">image-20230321205535450</figcaption>
</figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BD%9C%E4%B8%9A/" class="category-chain-item">作业</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">#系统设计</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>南京大学ics2019_PA1</div>
      <div>http://lunaticsky-tql.github.io/posts/4251/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lunatic sky</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/44749/" title="南京大学ics2019_PA2">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">南京大学ics2019_PA2</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/48981/" title="软件工程-软件设计作业">
                        <span class="hidden-mobile">软件工程-软件设计作业</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>
              
              




              
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  




  
  









    

    
        <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
            <i class="iconfont icon-arrowup" aria-hidden="true"></i>
        </a>
    

    
        <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
</main>

<footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

</footer>

<!-- Scripts -->

  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  <script  src="https://unpkg.com/leancloud-storage@4.12.2/dist/av-live-query-min.js" ></script>

  <script defer src="/js/zan.js" ></script>

  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>




<noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
</noscript>
<!-- hexo injector body_end start -->
  <script src="/js/out_of_date.js"></script>
<!-- hexo injector body_end end --></body>
</html>
