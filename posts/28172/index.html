

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
    <meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <meta name="theme-color" content="#2f4154">
    <meta name="author" content="Lunatic sky">
    <meta name="keywords" content="">
    
        <meta name="description" content="PA3实验报告 2013599 田佳业 一阶段 实现异常响应机制 对于x86，&quot;上文提到的新指令“比较多，这里先按在nanos-lite中make ARCH&#x3D;x86-nemu run报错的顺序来补充指令。   image-20230501195612494  查看手册，这是Grp7中lidt指令。   image-20230501195859504  IDTR的格式在这，Figure9-1:">
<meta property="og:type" content="article">
<meta property="og:title" content="南京大学ics2019_PA3">
<meta property="og:url" content="http://lunaticsky-tql.github.io/posts/28172/index.html">
<meta property="og:site_name" content="Lunaticsky&#39;s Blog">
<meta property="og:description" content="PA3实验报告 2013599 田佳业 一阶段 实现异常响应机制 对于x86，&quot;上文提到的新指令“比较多，这里先按在nanos-lite中make ARCH&#x3D;x86-nemu run报错的顺序来补充指令。   image-20230501195612494  查看手册，这是Grp7中lidt指令。   image-20230501195859504  IDTR的格式在这，Figure9-1:">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211426961668_883_20230601235657523461_176_image-20230501195612494.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211428026749_969_20230601235659951694_782_image-20230501195859504.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211429350111_168_20230601235705286388_738_image-20230501202135298.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211430306114_209_20230601235710126502_482_image-20230501202925594.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211431479331_469_20230601235712152820_107_image-20230501205158212.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211432470334_640_20230601235717680355_998_image-20230501215158239.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211433753019_996_20230601235720131761_628_image-20230501222920241.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211434803453_893_20230601235723245458_604_image-20230501223135299.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211436161726_962_20230601235726797182_626_image-20230501223811235.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211437260313_511_20230601235728897164_790_image-20230501233745814.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211438200351_288_20230601235731026927_345_image-20230502154536429.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211439456917_201_20230601235735629917_395_image-20230502155010170.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211440453947_652_20230601235740625541_326_image-20230502155347960.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211441604924_901_20230601235743907716_132_image-20230515195959094.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211442505567_744_20230601235747183942_216_image-20230515200157973.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211443525293_370_20230601235751693727_656_image-20230515203231772.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211444501936_479_20230601235754766515_943_image-20230515203537734.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211445507441_346_20230601235802225361_544_image-20230515211709483.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211446786000_613_20230601235805595522_997_image-20230517093932147.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211447927853_539_20230601235809798522_812_image-20230517120535802.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211449189955_553_20230601235812963148_940_image-20230517120133366.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211453140815_191_20230601235817127402_182_image-20230517154453440.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211456492222_910_20230601235821779651_126_image-20230517164713444.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211458145084_544_20230601235826834827_871_image-20230517164759642.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211459457348_581_20230601235833556085_425_image-20230517170756063.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211500565292_239_20230601235836104923_738_image-20230517170521104.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211502331847_228_20230601235838881129_188_image-20230517170629690.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211503669868_404_20230601235842381091_613_image-20230517174652184.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211504698736_903_20230601235844474454_763_image-20230517174823390.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211505735790_671_20230601235849337123_726_image-20230517174841335.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211506634831_668_20230601235852617171_673_image-20230517175011723.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211507894301_491_20230601235857281415_765_image-20230517180110224.png">
<meta property="article:published_time" content="2023-05-29T15:59:01.000Z">
<meta property="article:modified_time" content="2023-05-29T15:59:01.000Z">
<meta property="article:author" content="Lunatic sky">
<meta property="article:tag" content="系统设计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211426961668_883_20230601235657523461_176_image-20230501195612494.png">
    
    
    
    <title>南京大学ics2019_PA3 - Lunaticsky&#39;s Blog</title>

    
  
    <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
      
    <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />
      
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
      
        

          <!-- 主题依赖的图标库，不要自行修改 -->
          <!-- Do not modify the link that theme dependent icons -->
          
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">


            
<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


              <link  rel="stylesheet" href="/css/main.css" />

                
                  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
                    
                      <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
                        
                          

                            
                              
<link rel="stylesheet" href="/css/indeximg-hover.css">
<link rel="stylesheet" href="/css/remove-shadow.css">
<link rel="stylesheet" href="/css/zan.css">
<link rel="stylesheet" href="/css/code_fold.css">
<link rel="stylesheet" href="/css/link.css">

                                
    <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lunaticsky-tql.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"9zw4pzKGNFredmMKJc9n2JSH-gzGzoHsz","app_key":"rS2LQjQjNgLRcqtYrEVLwcSb","server_url":"https://9zw4pzkg.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
    <script  src="/js/utils.js" ></script>
    <script  src="/js/color-schema.js" ></script>
    

  

  

  

  

  

  

  
    
  


    <link  rel="stylesheet" href="/lib/font-awesome/css/all.min.css" />
    <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />
    <link  rel="stylesheet" href="/css/main.css" />

    
<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>


<header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lunatic sky‘s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/fan1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="南京大学ics2019_PA3"></span>
          
        </div>

        
          
  <div class="mt-3">
    
        
          <span class="post-meta">
            <i class="iconfont icon-date-fill" aria-hidden="true"></i>
            <time datetime="2023-05-29 23:59" pubdate>
              2023年5月29日 晚上
            </time>
          </span>
          
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
              17k 字
                
      </span>
      

        

            
              
                
                  <span id="leancloud-page-views-container" class="post-meta" style="display: none">
                    <i class="iconfont icon-eye" aria-hidden="true"></i>
                    <span id="leancloud-page-views"></span>
                       次
                  </span>
                  
                    
                          
                            <!-- add a sorce code icon -->
                            <span class="post-meta mr-2">
                              <i class="iconfont icon-code"></i>
                              <!-- a link with white font color -->
                              <!-- <a target="_blank" rel="noopener" href="https://butterfly.js.org/posts/4aa8abbe/" style="color: #fff">Source Code</a> -->
                              <!-- https://github.com/Lunaticsky-tql/blog_article_resources/blob/main/page.title.md -->
                              <!-- construct the souce code url-->
                              
                                <a target="_blank" rel="noopener" href="https://github.com/Lunaticsky-tql/blog_article_resources/blob/main/南京大学ics2019_PA3/南京大学ics2019_PA3.md" style="color: #EA7A99">Article Resource Link</a>
                            </span>
  </div>
  
        
      </div>

      
    </div>
  </div>
</div>

</div>

</header>

<main>
    
        

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">南京大学ics2019_PA3</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="pa3实验报告">PA3实验报告</h1>
<p>2013599 田佳业</p>
<h2 id="一阶段">一阶段</h2>
<h3 id="实现异常响应机制">实现异常响应机制</h3>
<p>对于x86，"上文提到的新指令“比较多，这里先按在<code>nanos-lite</code>中<code>make ARCH=x86-nemu run</code>报错的顺序来补充指令。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211426961668_883_20230601235657523461_176_image-20230501195612494.png" srcset="/img/loading.gif" lazyload alt="image-20230501195612494">
<figcaption aria-hidden="true">image-20230501195612494</figcaption>
</figure>
<p>查看手册，这是<code>Grp7</code>中<code>lidt</code>指令。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211428026749_969_20230601235659951694_782_image-20230501195859504.png" srcset="/img/loading.gif" lazyload alt="image-20230501195859504">
<figcaption aria-hidden="true">image-20230501195859504</figcaption>
</figure>
<p>IDTR的格式在这，Figure9-1:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211429350111_168_20230601235705286388_738_image-20230501202135298.png" srcset="/img/loading.gif" lazyload alt="image-20230501202135298">
<figcaption aria-hidden="true">image-20230501202135298</figcaption>
</figure>
<p>因此我们的寄存器结构应该长这样:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-7gzxuelmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-7gzxuelmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span>{
    <span class="hljs-type">rtlreg_t</span> limit : <span class="hljs-number">16</span>;
    <span class="hljs-type">rtlreg_t</span> base : <span class="hljs-number">32</span>;
} idtr;</code></pre></div></div>
<p>下面为其添加执行操作。我们可以在手册中查到对应的伪代码。因为我们用不到GDT(NEMU里没有分段机制)，因此只看上面部分即可。而且我们是模拟32位机器，根据我们寄存器结构的实现，我们只需要实现<code>ELSE</code>部分即可。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211430306114_209_20230601235710126502_482_image-20230501202925594.png" srcset="/img/loading.gif" lazyload alt="image-20230501202925594">
<figcaption aria-hidden="true">image-20230501202925594</figcaption>
</figure>
<p>综上，代码如下所示:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-d20q7klmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-d20q7klmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(lidt) {
  <span class="hljs-comment">//TODO();</span>
  <span class="hljs-built_in">rtl_li</span>(&amp;s0,id_dest-&gt;addr);
  cpu.idtr.limit=<span class="hljs-built_in">vaddr_read</span>(s0,<span class="hljs-number">2</span>);
  cpu.idtr.base=<span class="hljs-built_in">vaddr_read</span>(s0+<span class="hljs-number">2</span>,<span class="hljs-number">4</span>);
  <span class="hljs-built_in">print_asm_template1</span>(lidt);
}</code></pre></div></div>
<p>注册新指令，跑一下:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211431479331_469_20230601235712152820_107_image-20230501205158212.png" srcset="/img/loading.gif" lazyload alt="image-20230501205158212">
<figcaption aria-hidden="true">image-20230501205158212</figcaption>
</figure>
<p>嗯，该实现<code>int</code>指令了(之前注册过opcode_table，所以直接跳到这里了)</p>
<p>讲义中特意提及:</p>
<blockquote>
<p>你需要在自陷指令的helper函数中调用<code>raise_intr()</code>,
而不要把异常响应机制的代码放在自陷指令的helper函数中实现,
因为在后面我们会再次用到<code>raise_intr()</code>函数.</p>
</blockquote>
<p>因此我们先看这个函数该怎么实现。代码里只有一对括号，但讲义告诉我们了触发中断的响应过程:</p>
<ol type="1">
<li>依次将eflags, cs(代码段寄存器), eip(也就是PC)寄存器的值压栈</li>
<li>从IDTR中读出IDT的首地址</li>
<li>根据异常号在IDT中进行索引, 找到一个门描述符</li>
<li>将门描述符中的offset域组合成异常入口地址</li>
<li>跳转到异常入口地址</li>
</ol>
<p>为了diftest，我们需要手动添加<code>cs</code>寄存器，在寄存器结构体里补充一下即可。</p>
<p>下面是依据四个步骤实现的<code>raise_intr</code>。其中额外关中断防止嵌套中断，并检查了特权级(额外是指不这么做也不影响NEMU实现的正确)</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-w1qhyflmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-w1qhyflmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">raise_intr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> NO, <span class="hljs-type">vaddr_t</span> ret_addr)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Trigger an interrupt/exception with ``NO''.</span>
<span class="hljs-comment">   * That is, use ``NO'' to index the IDT.</span>
<span class="hljs-comment">   */</span>
  <span class="hljs-comment">// step1</span>
  <span class="hljs-built_in">rtl_push</span>(&amp;cpu.eflags.val);
  <span class="hljs-built_in">rtl_push</span>(&amp;cpu.cs);
  <span class="hljs-built_in">rtl_push</span>(&amp;ret_addr);
  cpu.eflags.IF = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// step2</span>
  <span class="hljs-type">uint32_t</span> gate_addr = cpu.idtr.base, len = cpu.idtr.limit;
  <span class="hljs-keyword">if</span> (len &lt;= NO)
  {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"the number is larger than the length of IDT!\n"</span>);
    <span class="hljs-built_in">assert</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-comment">//step3</span>
  <span class="hljs-type">uint32_t</span> val_l, val_h, p;
  val_l = <span class="hljs-built_in">vaddr_read</span>(gate_addr + NO * <span class="hljs-number">8</span>, <span class="hljs-number">2</span>);
  val_h = <span class="hljs-built_in">vaddr_read</span>(gate_addr + NO * <span class="hljs-number">8</span> + <span class="hljs-number">6</span>, <span class="hljs-number">2</span>);
  p = <span class="hljs-built_in">vaddr_read</span>(gate_addr + NO * <span class="hljs-number">8</span> + <span class="hljs-number">5</span>, <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">7</span>;
  <span class="hljs-comment">//actually no need to check p for NEMU, but we can do it.</span>
  <span class="hljs-keyword">if</span> (!p)
  {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The gatedesc is not allowed!"</span>);
    <span class="hljs-built_in">assert</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-comment">//step4</span>
  <span class="hljs-comment">//using rtl api</span>
  <span class="hljs-type">vaddr_t</span> goal = (val_h &lt;&lt; <span class="hljs-number">16</span>) + val_l;
  <span class="hljs-built_in">rtl_j</span>(goal);
}</code></pre></div></div>
<p>int指令根据手册有三种。<code>0xcc</code>的是断点，<code>0xcd</code>的是一般的中断指令，<code>0xce</code>是溢出中断指令。<code>0xcc</code>和<code>0xce</code>中断号分别为3和4。<code>decinfo.seq_pc</code>中保存的是int
指令的下一条指令。因此可以做以下实现:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-i6j6eblmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-i6j6eblmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(<span class="hljs-type">int</span>) {
<span class="hljs-comment">//  TODO();</span>
  <span class="hljs-keyword">switch</span>(decinfo.opcode){
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcc</span> : <span class="hljs-built_in">raise_intr</span>(<span class="hljs-number">0x3</span>,decinfo.seq_pc);  <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcd</span> : <span class="hljs-built_in">raise_intr</span>(id_dest-&gt;val, decinfo.seq_pc); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xce</span> : <span class="hljs-built_in">raise_intr</span>(<span class="hljs-number">0x4</span>, decinfo.seq_pc); <span class="hljs-keyword">break</span>;
    }
  <span class="hljs-built_in">print_asm</span>(<span class="hljs-string">"int %s"</span>, id_dest-&gt;str);

  <span class="hljs-built_in">difftest_skip_dut</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
}</code></pre></div></div>
<p>写完之后发现报错，是没有外部声明。在开头加上外部声明:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-khaa3nlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-khaa3nlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">raise_intr</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> NO, <span class="hljs-type">vaddr_t</span> ret_addr)</span></span>;</code></pre></div></div>
<p>关于讲义中提到阅读<code>_cte_init()</code>的代码,
找出相应的异常入口地址:对x86来说,
这个函数就是准备了一个有意义的IDT，出现异常的时候根据IDTR中保存的信息去找中断向量表即可。这个过程上面已经实现了。</p>
<p>然后是<code>iret</code>。这就是保存上下文部分的工作了，说明这一部分已经完成。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211432470334_640_20230601235717680355_998_image-20230501215158239.png" srcset="/img/loading.gif" lazyload alt="image-20230501215158239">
<figcaption aria-hidden="true">image-20230501215158239</figcaption>
</figure>
<h3 id="保存上下文">保存上下文</h3>
<p><code>iret</code>指令手册说的很复杂，但由于NEMU不涉及特权级和段机制，因此我们只需要关注一句话:</p>
<blockquote>
<p>In Real Address Mode, IRET pops the instruction pointer, CS, and the
flags register from the stack and resumes the interrupted routine.</p>
</blockquote>
<p>故可实现如下:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-d93mnilmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-d93mnilmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(iret) {
  <span class="hljs-comment">//TODO();</span>
  <span class="hljs-built_in">rtl_pop</span>(&amp;s0);
  <span class="hljs-built_in">rtl_j</span>(s0);
  <span class="hljs-built_in">rtl_pop</span>(&amp;cpu.cs);
  <span class="hljs-built_in">rtl_pop</span>(&amp;cpu.eflags.val);
  <span class="hljs-built_in">print_asm</span>(<span class="hljs-string">"iret"</span>);
}</code></pre></div></div>
<p>同<code>raise_intr</code>，恢复<code>eip</code>，更新decoding
中的跳转 eip
信息可以直接调用<code>rtl_j</code>实现。实际上就是跳到调用中断的地方去了。</p>
<p><code>pusha</code></p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211433753019_996_20230601235720131761_628_image-20230501222920241.png" srcset="/img/loading.gif" lazyload alt="image-20230501222920241">
<figcaption aria-hidden="true">image-20230501222920241</figcaption>
</figure>
<p>顾名思义，它的功能是把所有通用寄存器都压入栈中。这个可以说是非常赏心悦目了，对照实现即可。<code>popa</code>显然也是对称的，不再赘述。</p>
<p><img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211434803453_893_20230601235723245458_604_image-20230501223135299.png" srcset="/img/loading.gif" lazyload alt="image-20230501223135299" width="50%" height="50%"></p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-fykg0elmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-fykg0elmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(pusha) {
  <span class="hljs-comment">//TODO();</span>
    <span class="hljs-built_in">rtl_mv</span>(&amp;s0,&amp;cpu.esp);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.eax);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.ecx);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.edx);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.ebx);
	<span class="hljs-built_in">rtl_push</span>(&amp;s0);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.ebp);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.esi);
	<span class="hljs-built_in">rtl_push</span>(&amp;cpu.edi);
	<span class="hljs-built_in">print_asm</span>(<span class="hljs-string">"pusha"</span>);
}</code></pre></div></div>
<p>接下来讲义要求我们重新组织<code>Context</code>结构体。这个地方卡了一段时间，确实如讲义所说，必须要理解整个中断调用过程，只看代码是看不出什么的。</p>
<p>触发异常后硬件处理第一步是通过<code>raise_intr</code>依次将触发异常时的PC和处理器状态(对于x86来说就是eflags,
cs和eip)压栈，根据异常号找到中断向量表中的中断描述符，描述符给出了该执行哪个中断。比如如果是80系统调用，程序运行后会触发<code>trap.S</code>汇编代码上面的第一个函数<code>__am_vecsys</code>，会压入异常号，然后跳转到<code>__am_asm_trap()</code>。在
<code>__am_asm_trap()</code>中，代码将会把用户进程的通用寄存器通过<code>pusha</code>保存到堆栈上。由此形成了陷阱帧。栈由改地址往低地址延伸，因此<code>_Context</code>的顺序与此相反，或者说和<code>popa</code>的顺序是一致的。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-vqpi39lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-vqpi39lmrc2t9m"><pre><code class="hljs C++">#----|------------entry------------|---irq id---|-----handler-----|
.globl __am_vecsys;    __am_vecsys: pushl $<span class="hljs-number">0x80</span>; jmp __am_asm_trap
......
__am_asm_trap:
  pushal

  pushl $<span class="hljs-number">0</span>

  pushl %esp
  call __am_irq_handle</code></pre></div></div>
<h3 id="事件分发">事件分发</h3>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211436161726_962_20230601235726797182_626_image-20230501223811235.png" srcset="/img/loading.gif" lazyload alt="image-20230501223811235">
<figcaption aria-hidden="true">image-20230501223811235</figcaption>
</figure>
<p>讲义中指出，这是因为CTE的<code>__am_irq_handle()</code>函数并未正确识别出自陷事件.
根据<code>_yield()</code>的定义,
<code>__am_irq_handle()</code>函数需要将自陷事件打包成编号为<code>_EVENT_YIELD</code>的事件。让它识别一下就好:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-h95n58lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-h95n58lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (c-&gt;irq) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0x81</span>:ev.event=_EVENT_YIELD;<span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>: ev.event = _EVENT_ERROR; <span class="hljs-keyword">break</span>;
}</code></pre></div></div>
<p><code>do_event</code>也识别一下:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-0yrlqqlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-0yrlqqlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (e.event) {
    <span class="hljs-keyword">case</span> _EVENT_YIELD:  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"_EVENT_YIELD recognized"</span>);<span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>: <span class="hljs-built_in">panic</span>(<span class="hljs-string">"Unhandled event ID = %d"</span>, e.event);
}</code></pre></div></div>
<p>可以看到识别出来了。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211437260313_511_20230601235728897164_790_image-20230501233745814.png" srcset="/img/loading.gif" lazyload alt="image-20230501233745814">
<figcaption aria-hidden="true">image-20230501233745814</figcaption>
</figure>
<h3 id="恢复上下文">恢复上下文</h3>
<p>恢复上下文需要完成<code>popa</code>操作。因为我在实现<code>pusha</code>的时候已经完成了，因此这里直接触发了<code>panic</code>，任务完成。</p>
<h3 id="必答题">必答题</h3>
<h6 id="从nanos-lite调用_yield开始-到从_yield返回的期间-这一趟旅程具体经历了什么">从Nanos-lite调用<code>_yield()</code>开始,
到从<code>_yield()</code>返回的期间, 这一趟旅程具体经历了什么？</h6>
<p>1.<code>nexus-am/am/src/x86/nemu/cte.c</code> 中，_yield
函数中执行指令 int 0x81。</p>
<p></p><div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-l2cf2rlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-l2cf2rlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-type">void</span> _yield() {
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(<span class="hljs-string">"int $0x81"</span>)</span></span>;
}</code></pre></div></div><p></p>
<p>2.<code>nemu/src/isa/x86/exec/system.c</code>
中，<code>exec_int</code> 函数为 nemu 对 int 指令的执行函数，其中调用了
<code>raise_intr</code> 函数，参数为 int 中断编号(此处为 0x81)以及当前的
PC 值。一般的中断走的是<code>0xcd</code>分支。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-ph0fgalmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-ph0fgalmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(<span class="hljs-type">int</span>) {
<span class="hljs-comment">//  TODO();</span>
  <span class="hljs-keyword">switch</span>(decinfo.opcode){
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcc</span> : <span class="hljs-built_in">raise_intr</span>(<span class="hljs-number">0x3</span>,decinfo.seq_pc);  <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xcd</span> : <span class="hljs-built_in">raise_intr</span>(id_dest-&gt;val, decinfo.seq_pc); <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">0xce</span> : <span class="hljs-built_in">raise_intr</span>(<span class="hljs-number">0x4</span>, decinfo.seq_pc); <span class="hljs-keyword">break</span>;
    }
  <span class="hljs-built_in">print_asm</span>(<span class="hljs-string">"int %s"</span>, id_dest-&gt;str);

  <span class="hljs-built_in">difftest_skip_dut</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
}</code></pre></div></div>
<p>3.<code>nemu/src/isa/x86/intr.c</code> 中，<code>raise_intr</code>
函数中读取中断描述符表
idt，根据传入的中断编号得到中断处理程序的入口地址(中断描述符表的初始化在<code>_cte_init</code>
函数中完成)。接下来就是讲义中的<code>触发异常后硬件的响应过程</code>，我们依次对寄存器
eflags ,cs,eip
进行压栈，根据IDT找到入口地址，最后将程序转移到中断处理程序入口地址处继续执行。当中断编号为
0x81 时，在<code>nexus-am/am/src/x86/nemu/cte.c</code>
中的<code>_cte_init</code>
函数中我们可以看到中断处理程序为<code>__am_vectrap</code>
函数(下面<code>idt[0x81]</code>这一行），因此<code>raise_intr</code>
最终的效果是将虚拟机内部运行的程序转移到了其中断服务程序处继续执行。nemu
完成了 int 指令的执行。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-vjrjqblmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-vjrjqblmrc2t9m"><pre><code class="hljs C++"><span class="hljs-type">int</span> _cte_init(_Context*(*handler)(_Event, _Context*)) {
  <span class="hljs-type">static</span> GateDesc idt[NR_IRQ];
  <span class="hljs-comment">// initialize IDT</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; NR_IRQ; i ++) {
    idt[i] = <span class="hljs-built_in">GATE</span>(STS_TG32, <span class="hljs-built_in">KSEL</span>(SEG_KCODE), __am_vecnull, DPL_KERN);
  }
  <span class="hljs-comment">// ----------------------- interrupts ----------------------------</span>
  idt[<span class="hljs-number">32</span>]   = <span class="hljs-built_in">GATE</span>(STS_IG32, <span class="hljs-built_in">KSEL</span>(SEG_KCODE), __am_irq0,   DPL_KERN);
  <span class="hljs-comment">// ---------------------- system call ----------------------------</span>
  idt[<span class="hljs-number">0x80</span>] = <span class="hljs-built_in">GATE</span>(STS_TG32, <span class="hljs-built_in">KSEL</span>(SEG_KCODE), __am_vecsys, DPL_USER);
  idt[<span class="hljs-number">0x81</span>] = <span class="hljs-built_in">GATE</span>(STS_TG32, <span class="hljs-built_in">KSEL</span>(SEG_KCODE), __am_vectrap, DPL_KERN);
  <span class="hljs-built_in">set_idt</span>(idt, <span class="hljs-built_in">sizeof</span>(idt));
  <span class="hljs-comment">// register event handler</span>
  user_handler = handler;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div></div>
<p>4.<code>__am_vectrap</code>
位于<code>nexus-am/am/src/x86/nemu/trap.S</code> 中，将整数 0x81
入栈，跳转到<code>__am_asm_trap</code>
继续执行。进行一系列压栈操作后(压的其实就是<code>_Context</code>结构体这个参数，这回答了讲义中“<code>__am_irq_handle()</code>有一个上下文结构指针<code>c</code>这个上下文结构<code>c</code>是怎么来的”这个问题)，转移到函数<code>__am_irq_handle</code>
处执行。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-fmt9bplmrc2t9m"></i><span>assembly</span><div class="collapse show" id="collapse-fmt9bplmrc2t9m"><pre><code class="hljs assembly">.globl __am_vectrap;  __am_vectrap: pushl $0x81; jmp __am_asm_trap
    
__am_asm_trap:
  pushal

  pushl $0

  pushl %esp
  call __am_irq_handle

  addl $4, %esp

  addl $4, %esp
  popal
  addl $4, %esp

  iret</code></pre></div></div>
<p>5.<code>nexus-am/am/src/x86/nemu/cte.c</code>
中，函数<code>__am_irq_handle</code> 根据栈(上下文)
中保存的中断号对事件进行打包，调用<code>user_handler</code>对事件进行处理。其中<code>user_handler</code>
在<code>_cte_init</code> 中进行了初始化，为<code>do_event</code>
函数。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-o4090olmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-o4090olmrc2t9m"><pre><code class="hljs C++">_Context* __am_irq_handle(_Context *c) {
  _Context *next = c;
  <span class="hljs-keyword">if</span> (user_handler) {
    _Event ev = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">switch</span> (c-&gt;irq) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0x81</span>:ev.event=_EVENT_YIELD;<span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>: ev.event = _EVENT_ERROR; <span class="hljs-keyword">break</span>;
    }

    next = <span class="hljs-built_in">user_handler</span>(ev, c);
    <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">NULL</span>) {
      next = c;
    }
  }
  <span class="hljs-keyword">return</span> next;
}</code></pre></div></div>
<p><code>user_handler</code>
是怎么初始化的呢？具体是<code>_cte_init</code> 中
<code>user_handler = handler;</code>这一句，而这个参数<code>handler</code>是<code>init_irq</code>时调用时传给它的，这也回到了<code>main</code>函数为实现上下文做准备的阶段。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-ph489jlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-ph489jlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init_irq</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{
  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"Initializing interrupt/exception handler..."</span>);
  _cte_init(do_event);
}</code></pre></div></div>
<p>6.<code>nanos-lite/src/irq.c</code> 中，<code>do_event</code>
函数对传入的时间进行解析，做出相应的操作，对于 <code>yield</code>
操作，我们现在直接输出一段文本，表示程序运行至此即可。顾名思义的话应该是要做进程调度，但我们现在仅有一个上下文，因此不做上下文切换，此处直接返回<code>NULL</code>
给<code>__am_irq_handle</code>。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-ss8x2slmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-ss8x2slmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> _Context* <span class="hljs-title">do_event</span><span class="hljs-params">(_Event e, _Context* c)</span> </span>{
  <span class="hljs-keyword">switch</span> (e.event) {
    <span class="hljs-keyword">case</span> _EVENT_YIELD:  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"_EVENT_YIELD recognized"</span>);<span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>: <span class="hljs-built_in">panic</span>(<span class="hljs-string">"Unhandled event ID = %d"</span>, e.event);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}</code></pre></div></div>
<p>7.接下来就是沿着上述调用链逐级返回的操作。<code>__am_irq_handle</code>
得到 <code>do_event</code>返回的
<code>NULL</code>后，不做上下文切换，直接将传入的上下文返回给调用者<code>__am_asm_trap</code>，
经过适当的出栈操作后，使用 <code>iret</code>
指令进行中断返回，回复现场，回到中断前程序的执行位置。至此，一次自陷操作全部完成。</p>
<p><code>__am_irq_handle</code>:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-72nq3nlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-72nq3nlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (next == <span class="hljs-literal">NULL</span>) {
    next = c;
}
}
<span class="hljs-keyword">return</span> next;</code></pre></div></div>
<p><code>trap.S</code></p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-esz4zglmrc2t9m"></i><span>assembly</span><div class="collapse show" id="collapse-esz4zglmrc2t9m"><pre><code class="hljs assembly">call __am_irq_handle

addl $4, %esp

addl $4, %esp
popal
addl $4, %esp

iret</code></pre></div></div>
<p><code>iret</code></p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-5lsi28lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-5lsi28lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-built_in">make_EHelper</span>(iret) {
  <span class="hljs-built_in">rtl_pop</span>(&amp;s0);
  <span class="hljs-built_in">rtl_j</span>(s0);
  <span class="hljs-built_in">rtl_pop</span>(&amp;cpu.cs);
  <span class="hljs-built_in">rtl_pop</span>(&amp;cpu.eflags.val);
  <span class="hljs-built_in">print_asm</span>(<span class="hljs-string">"iret"</span>);
}</code></pre></div></div>
<p>这个必答题按照整个触发中断时进行上下文管理的过程梳理了一遍。上述实现的过程中是发现缺什么需要补充的，看懂局部的过程进行补充，而在此对整个过程进行了整体的总结。</p>
<h3 id="思考题">思考题</h3>
<h6 id="对比异常处理与函数调用">对比异常处理与函数调用</h6>
<p>我们知道进行函数调用的时候也需要保存调用者的状态: 返回地址,
以及calling convention中需要调用者保存的寄存器.
而CTE在保存上下文的时候却要保存更多的信息. 尝试对比它们,
并思考两者保存信息不同是什么原因造成的。</p>
<blockquote>
<p>综合上述提到的异常处理过程，对于x86多保存的主要有eflags
,cs,eip和通用寄存器。主要原因是调用子程序过程发生的时间是已知和固定的，即在主程序中的调用指令
（CALL）执行时发生，所以我们只需要保存子函数中需要的东西，以及保存返回地址，ebp确保能回到调用者那里就可以。而中断/异常发生的时间一般是随机的。意味着我们需要为当前的寄存器状态提供一个“快照”，因此几乎保存了所有的寄存器。</p>
</blockquote>
<h2 id="二阶段">二阶段</h2>
<h3 id="实现loader">实现loader</h3>
<p>讲义中指出，现在的ramdisk十分简单, 它只有一个文件,
就是我们将要加载的用户程序<code>dummy</code>,可执行文件位于ramdisk偏移为0处,
访问它就可以得到用户程序的第一个字节.</p>
<p>关于用户程序需要加载到的内存位置</p>
<p>ics2019是这么说的:</p>
<blockquote>
<p>为了避免和Nanos-lite的内容产生冲突,
我们约定目前用户程序需要被链接到内存位置<code>0x3000000</code>(x86)或<code>0x83000000</code>(mips32或riscv32)附近,
Navy-apps已经设置好了相应的选项(见<code>navy-apps/Makefile.compile</code>中的<code>LDFLAGS</code>变量).</p>
</blockquote>
<p>ics2018</p>
<blockquote>
<p>用户程序需要被链接到内存位置<code>0x4000000</code>处</p>
</blockquote>
<p>而且，ics2018这个是作为第一个热身任务，是这么说的:</p>
<blockquote>
<p>loader 只需要做一件事情:将 ramdisk 中从 0 开始的所有内容放置在
0x4000000,并把这个地 址作为程序的入口返回即可。</p>
</blockquote>
<p>但ics2019这个地方就有些复杂，这个地方也研究了好半天。其中<a target="_blank" rel="noopener" href="https://vgalaxy.work/2022/01/01/icspa3/#%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6">这篇博客</a>造了一个轮子，但也让我清楚了到底想让我们干什么。</p>
<p>程序开始的地方由ELF header中的Entry point
address来指示，因此我们读出来，返回这个入口地址就可以了。下面的<code>naive_uload</code>
将程序入口强制转换一个函数指针并调用，因此我们确信就直接返回这个地址值就可以了。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-dse8twlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-dse8twlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">naive_uload</span><span class="hljs-params">(PCB *pcb, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename)</span> </span>{
  <span class="hljs-type">uintptr_t</span> entry = <span class="hljs-built_in">loader</span>(pcb, filename);
  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"Jump to entry = %p"</span>, entry);
  ((<span class="hljs-built_in">void</span>(*)())entry) ();
}</code></pre></div></div>
<p>但是讲义里还提到:</p>
<blockquote>
<p>你需要找出每一个需要加载的segment的<code>Offset</code>,
<code>VirtAddr</code>,
<code>FileSiz</code>和<code>MemSiz</code>这些参数.
其中相对文件偏移<code>Offset</code>指出相应segment的内容从ELF文件的第<code>Offset</code>字节开始,
在文件中的大小为<code>FileSiz</code>,
它需要被分配到以<code>VirtAddr</code>为首地址的虚拟内存位置,
在内存中它占用大小为<code>MemSiz</code>. 也就是说,
这个segment使用的内存就是<code>[VirtAddr, VirtAddr + MemSiz)</code>这一连续区间,
然后将segment的内容从ELF文件中读入到这一内存区间,
并将<code>[VirtAddr + FileSiz, VirtAddr + MemSiz)</code>对应的物理区间清零。</p>
</blockquote>
<p>因此还没完。我们没有做清零的工作。因此我们还要根据ELF
header知道有几个segments，然后从Program
Header中知道segment的属性。讲义中有一个图表现的比较清楚。然后对每一个段清零。代码如下所示:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-h2twyolmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-h2twyolmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">uintptr_t</span> <span class="hljs-title">loader</span><span class="hljs-params">(PCB *pcb, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename)</span> </span>{
  <span class="hljs-comment">// TODO();</span>
  Elf_Ehdr elf_header;
  <span class="hljs-type">size_t</span> offset=<span class="hljs-built_in">ramdisk_read</span>(&amp;elf_header,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(Elf_Ehdr));
  <span class="hljs-built_in">assert</span>(offset==<span class="hljs-built_in">sizeof</span>(Elf_Ehdr));
  Elf_Phdr elf_program_header[elf_header.e_phnum];
  offset=<span class="hljs-built_in">ramdisk_read</span>(elf_program_header,elf_header.e_phoff,<span class="hljs-built_in">sizeof</span>(Elf_Phdr)*elf_header.e_phnum);
  <span class="hljs-built_in">assert</span>(offset==<span class="hljs-built_in">sizeof</span>(Elf_Phdr)*elf_header.e_phnum);
  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;elf_header.e_phnum;i++){
    <span class="hljs-comment">// only load PT_LOAD type</span>
    <span class="hljs-keyword">if</span>(elf_program_header[i].p_type==PT_LOAD){
      <span class="hljs-built_in">ramdisk_read</span>((<span class="hljs-type">void</span>*)elf_program_header[i].p_vaddr,elf_program_header[i].p_offset,elf_program_header[i].p_memsz);
      <span class="hljs-comment">// clear the [Virtual Address + File Size, Virtual Address + Memory Size)</span>
      <span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span>*)(elf_program_header[i].p_vaddr+elf_program_header[i].p_filesz),<span class="hljs-number">0</span>,elf_program_header[i].p_memsz-elf_program_header[i].p_filesz);
    }
  }
  <span class="hljs-keyword">return</span> elf_header.e_entry;
}</code></pre></div></div>
<p>实现完了按照提示在<code>init_proc()</code>中调用<code>naive_uload(NULL, NULL)</code>。需要在上面声明一下:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-zd62eglmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-zd62eglmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init_proc</span><span class="hljs-params">()</span> </span>{
  switch_boot_pcb();
  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"Initializing processes..."</span>);
  <span class="hljs-comment">// load program here</span>
  <span class="hljs-built_in">naive_uload</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
}</code></pre></div></div>
<p>但是为什么报错呢？使用<code>objdump -S dummy-x86 &gt;dump.txt</code>查看<code>dummy</code>的反汇编代码，发现入口确实找对了，还是这个<code>endbr32</code>的
鬼。这好说，改一改编译选项的事，PA2已经遇到过了。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211438200351_288_20230601235731026927_345_image-20230502154536429.png" srcset="/img/loading.gif" lazyload alt="image-20230502154536429">
<figcaption aria-hidden="true">image-20230502154536429</figcaption>
</figure>
<p>加到<code>navy_apps</code>的<code>Makefile.compile</code>里面就好。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211439456917_201_20230601235735629917_395_image-20230502155010170.png" srcset="/img/loading.gif" lazyload alt="image-20230502155010170">
<figcaption aria-hidden="true">image-20230502155010170</figcaption>
</figure>
<p>同理，在<code>navy_apps</code>底下也要<code>make clean</code>才能生效。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211440453947_652_20230601235740625541_326_image-20230502155347960.png" srcset="/img/loading.gif" lazyload alt="image-20230502155347960">
<figcaption aria-hidden="true">image-20230502155347960</figcaption>
</figure>
<p>说明loader已经成功加载dummy。</p>
<h6 id="堆和栈在哪里">堆和栈在哪里</h6>
<blockquote>
<p>栈的使用只发生在函数调用过程中，堆的使用只发生在malloc/free函数调用之后，因此它们都只在动态时有意义，这是为什么它们不需要出现在可执行文件中。</p>
</blockquote>
<h6 id="如何识别不同格式的可执行文件">如何识别不同格式的可执行文件?</h6>
<p>如果你在GNU/Linux下执行一个从Windows拷过来的可执行文件,
将会报告"格式错误". 思考一下, GNU/Linux是如何知道"格式错误"的?</p>
<blockquote>
<p>根据ELF 文件头的前 4 个字节即“魔数”判断。</p>
</blockquote>
<h6 id="为什么要清零">为什么要清零?</h6>
<p>为什么需要将 <code>[VirtAddr + FileSiz, VirtAddr + MemSiz)</code>
对应的物理区间清零?</p>
<blockquote>
<p>如讲义中所说，FileSiz 表示这个段在文件中的大小，而 MemSiz
表示这个段在内存中的大小。我们知道可执行文件的各个段包括代码段、数据段、BSS
段等。由于 BSS 段没有实际的数据，所以它的 FileSiz 为 0，而 MemSiz
表示它需要占用的空间大小。BSS
段是程序运行时未初始化的全局变量和静态变量所占据的内存空间，我们写C程序知道这变量默认应当为0的，因此要清零。</p>
</blockquote>
<h3 id="识别系统调用">识别系统调用</h3>
<p><code>a[0] = c-&gt;GPR1;</code>保存的是系统调用的参数，<code>dummy</code>程序,
它触发了一个<code>SYS_yield</code>系统调用. 我们约定,
这个系统调用直接调用CTE的<code>_yield()</code>即可,
然后返回<code>0</code>.因此我们需要处理的第一个<code>case</code>是<code>SYS_yield</code>。下面又说“处理系统调用的最后一件事就是设置系统调用的返回值.
对于不同的ISA, 系统调用的返回值存放在不同的寄存器中,
宏<code>GPRx</code>用于实现这一抽象,
所以我们通过<code>GPRx</code>来进行设置系统调用返回值即可.”换句话说，刚才的返回0就是把这个<code>GPRx</code>寄存器设置成0；查看宏定义，它在<code>x86</code>中是<code>eip</code>。这不是胡扯吗。。<code>eip</code>是指针寄存器，返回值应当存到通用寄存器里啊。看要求果然有“在<code>nexus-am/am/include/arch/$ISA-nemu.h</code>中实现正确的<code>GPR?</code>宏”，因此我们先把这个错改过来:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-mqf2qflmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-mqf2qflmrc2t9m"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> GPR1 eax</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPR2 ebx</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPR3 ecx</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPR4 edx</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPRx eax</span></code></pre></div></div>
<p>依据的是下面的定义:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-byitiplmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-byitiplmrc2t9m"><pre><code class="hljs C++"><span class="hljs-comment">// ISA-depedent definitions</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__ISA_X86__)</span>
<span class="hljs-meta"># <span class="hljs-keyword">define</span> ARGS_ARRAY (<span class="hljs-string">"int $0x80"</span>, <span class="hljs-string">"eax"</span>, <span class="hljs-string">"ebx"</span>, <span class="hljs-string">"ecx"</span>, <span class="hljs-string">"edx"</span>, <span class="hljs-string">"eax"</span>)</span></code></pre></div></div>
<p>这个ARRAY对应的就是封装的系统调用的四个参数:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-c2zajrlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-c2zajrlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-type">intptr_t</span> _syscall_(<span class="hljs-type">intptr_t</span> type, <span class="hljs-type">intptr_t</span> a0, <span class="hljs-type">intptr_t</span> a1, <span class="hljs-type">intptr_t</span> a2) {
  <span class="hljs-function"><span class="hljs-keyword">register</span> <span class="hljs-type">intptr_t</span> _gpr1 <span class="hljs-title">asm</span> <span class="hljs-params">(GPR1)</span> </span>= type;
  <span class="hljs-function"><span class="hljs-keyword">register</span> <span class="hljs-type">intptr_t</span> _gpr2 <span class="hljs-title">asm</span> <span class="hljs-params">(GPR2)</span> </span>= a0;
  <span class="hljs-function"><span class="hljs-keyword">register</span> <span class="hljs-type">intptr_t</span> _gpr3 <span class="hljs-title">asm</span> <span class="hljs-params">(GPR3)</span> </span>= a1;
  <span class="hljs-function"><span class="hljs-keyword">register</span> <span class="hljs-type">intptr_t</span> _gpr4 <span class="hljs-title">asm</span> <span class="hljs-params">(GPR4)</span> </span>= a2;
  <span class="hljs-function"><span class="hljs-keyword">register</span> <span class="hljs-type">intptr_t</span> ret <span class="hljs-title">asm</span> <span class="hljs-params">(GPRx)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(SYSCALL : <span class="hljs-string">"=r"</span> (ret) : <span class="hljs-string">"r"</span>(_gpr1), <span class="hljs-string">"r"</span>(_gpr2), <span class="hljs-string">"r"</span>(_gpr3), <span class="hljs-string">"r"</span>(_gpr4))</span></span>;
  <span class="hljs-keyword">return</span> ret;
}</code></pre></div></div>
<p>然后我们去按部就班实现“约定”:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-jiltbrlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-jiltbrlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (a[<span class="hljs-number">0</span>]) {
    <span class="hljs-keyword">case</span> SYS_yield: _yield(); c-&gt;GPRx = <span class="hljs-number">0</span>; <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>: <span class="hljs-built_in">panic</span>(<span class="hljs-string">"Unhandled syscall ID = %d"</span>, a[<span class="hljs-number">0</span>]);
}</code></pre></div></div>
<p><code>do_event</code>分发:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-q19ob8lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-q19ob8lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> _EVENT_SYSCALL:
<span class="hljs-built_in">Log</span>(<span class="hljs-string">"EVENT_SYSCALL"</span>);
<span class="hljs-built_in">do_syscall</span>(c);</code></pre></div></div>
<p>发现还是不行。因为做完上下文管理和做这一部分中间隔了一段时间写qt大作业，所以不太熟悉了。仔细回顾了这一部分发现是没有在am中处理中断指令:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-ow2qbllmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-ow2qbllmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (c-&gt;irq)
{
<span class="hljs-keyword">case</span> <span class="hljs-number">0x80</span>:
  ev.event = _EVENT_SYSCALL;
  <span class="hljs-keyword">break</span>;
<span class="hljs-keyword">case</span> <span class="hljs-number">0x81</span>:
  ev.event = _EVENT_YIELD;
  <span class="hljs-keyword">break</span>;
<span class="hljs-keyword">default</span>:
  ev.event = _EVENT_ERROR;
  <span class="hljs-keyword">break</span>;
}</code></pre></div></div>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211441604924_901_20230601235743907716_132_image-20230515195959094.png" srcset="/img/loading.gif" lazyload alt="image-20230515195959094">
<figcaption aria-hidden="true">image-20230515195959094</figcaption>
</figure>
<p>这次对了。0号事件好说。按照提示直接调用<code>_halt</code></p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-po9dd7lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-po9dd7lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> SYS_exit: _halt(a[<span class="hljs-number">1</span>]); <span class="hljs-keyword">break</span>;</code></pre></div></div>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211442505567_744_20230601235747183942_216_image-20230515200157973.png" srcset="/img/loading.gif" lazyload alt="image-20230515200157973">
<figcaption aria-hidden="true">image-20230515200157973</figcaption>
</figure>
<h3 id="操作系统之上的trm">操作系统之上的TRM</h3>
<h4 id="标准输出">标准输出</h4>
<p>根据<code>write</code>的函数声明(不用man，代码里也可以看出来)</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-t59dovlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-t59dovlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-type">int</span> _write(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> count) {
 <span class="hljs-keyword">return</span> _syscall_(SYS_write, fd, (<span class="hljs-type">intptr_t</span>)buf, count);
}</code></pre></div></div>
<p>在<code>do_syscall()</code>中识别出系统调用号是<code>SYS_write</code>之后,
检查<code>fd</code>的值,
如果<code>fd</code>是<code>1</code>或<code>2</code>(分别代表<code>stdout</code>和<code>stderr</code>),
则将<code>buf</code>为首地址的<code>len</code>字节输出到串口(使用<code>_putc()</code>即可).
最后还要设置正确的返回值,</p>
<p>这一步就要man一下看看了。返回值的含义:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211443525293_370_20230601235751693727_656_image-20230515203231772.png" srcset="/img/loading.gif" lazyload alt="image-20230515203231772">
<figcaption aria-hidden="true">image-20230515203231772</figcaption>
</figure>
<p>因此可做如下实现(<code>do_syscall</code>中):</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-j88089lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-j88089lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> SYS_write:
{
  <span class="hljs-type">int</span> fd = (<span class="hljs-type">int</span>)a[<span class="hljs-number">1</span>];
  <span class="hljs-type">char</span> *buf = (<span class="hljs-type">char</span> *)a[<span class="hljs-number">2</span>];
  <span class="hljs-type">size_t</span> len = (<span class="hljs-type">size_t</span>)a[<span class="hljs-number">3</span>];
  <span class="hljs-keyword">if</span>(fd==<span class="hljs-number">1</span>||fd==<span class="hljs-number">2</span>){
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;len;++i,++buf)
      _putc(*buf);
    c-&gt;GPRx=len;
  }
  <span class="hljs-keyword">else</span>{
    c-&gt;GPRx=<span class="hljs-number">-1</span>;
  }
        <span class="hljs-keyword">break</span>;
}</code></pre></div></div>
<p>不要忘了加<code>break</code>。。。。</p>
<p>好了，我们成功运行了永不停息的hello world。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211444501936_479_20230601235754766515_943_image-20230515203537734.png" srcset="/img/loading.gif" lazyload alt="image-20230515203537734">
<figcaption aria-hidden="true">image-20230515203537734</figcaption>
</figure>
<h4 id="堆区管理">堆区管理</h4>
<p><code>_sbrk()</code>实现:</p>
<ol type="1">
<li>program break一开始的位置位于<code>_end</code></li>
<li>被调用时, 根据记录的program break位置和参数<code>increment</code>,
计算出新program break</li>
<li>通过<code>SYS_brk</code>系统调用来让操作系统设置新program break</li>
<li>若<code>SYS_brk</code>系统调用成功, 该系统调用会返回<code>0</code>,
此时更新之前记录的program break的位置, 并将旧program
break的位置作为<code>_sbrk()</code>的返回值返回</li>
<li>若该系统调用失败, <code>_sbrk()</code>会返回<code>-1</code></li>
</ol>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-13ndemlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-13ndemlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> _end;
...
<span class="hljs-type">static</span> <span class="hljs-type">intptr_t</span> program_break=(<span class="hljs-type">intptr_t</span>)&amp;_end;
<span class="hljs-type">void</span> *_sbrk(<span class="hljs-type">intptr_t</span> increment) {
  <span class="hljs-type">intptr_t</span> prev_break=program_break;
  <span class="hljs-keyword">if</span>(_syscall_(SYS_brk,program_break+increment,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)==<span class="hljs-number">0</span>){
    program_break+=increment;
  <span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)prev_break;
  }
  <span class="hljs-keyword">else</span>{
    <span class="hljs-built_in">return</span> (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>;
  }
}</code></pre></div></div>
<p>暂时只有单道应用程序，认为堆区分配总能成功:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-u5jxurlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-u5jxurlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> SYS_brk:
  c-&gt;GPRx = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">break</span>;</code></pre></div></div>
<p>输出能够走缓冲区了:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211445507441_346_20230601235802225361_544_image-20230515211709483.png" srcset="/img/loading.gif" lazyload alt="image-20230515211709483">
<figcaption aria-hidden="true">image-20230515211709483</figcaption>
</figure>
<h3 id="必答题-1">必答题</h3>
<h6 id="hello程序是什么-它从而何来-要到哪里去它能吃吗">hello程序是什么,
它从而何来, 要到哪里去，<del>它能吃吗</del></h6>
<h2 id="三阶段">三阶段</h2>
<h3 id="让loader使用文件">让loader使用文件</h3>
<p>实验指导书中说，需要先实现<code>fs_open()</code>,
<code>fs_read()</code>和<code>fs_close()</code>,
这样就可以在loader中使用文件名来指定加载的程序了。但是按照指导书的指示先实现了这三个指令，仿照原来的loader把所有的<code>randisk_read</code>改成<code>fs_read</code>后却一直内存超限。一想，<code>fs_read</code>只能从当前的open_offset开始读啊，读pheader时我们要从<code>elf_header.e_phoff</code>开始读。后面读每个块的时候也是类似。所以<code>fs_lseek</code>还是必不可少。当时实现loader的细节有些模糊了，所以干了蠢事。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-mrlwqdlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-mrlwqdlmrc2t9m"><pre><code class="hljs C++">Elf_Ehdr elf_header;
<span class="hljs-type">int</span> fd = <span class="hljs-built_in">fs_open</span>(filename,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
<span class="hljs-built_in">Log</span>(<span class="hljs-string">"filename: %s, fd: %d"</span>, filename, fd);
<span class="hljs-type">size_t</span> read_len = <span class="hljs-built_in">fs_read</span>(fd, &amp;elf_header, <span class="hljs-built_in">sizeof</span>(Elf_Ehdr));
<span class="hljs-built_in">assert</span>(read_len == <span class="hljs-built_in">sizeof</span>(Elf_Ehdr));
Elf_Phdr elf_program_header[elf_header.e_phnum];
<span class="hljs-built_in">fs_lseek</span>(fd, elf_header.e_phoff, SEEK_SET);
read_len = <span class="hljs-built_in">fs_read</span>(fd, elf_program_header, <span class="hljs-built_in">sizeof</span>(Elf_Phdr) * elf_header.e_phnum);
<span class="hljs-built_in">assert</span>(read_len == <span class="hljs-built_in">sizeof</span>(Elf_Phdr) * elf_header.e_phnum);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; elf_header.e_phnum; i++)
{
  <span class="hljs-comment">// only load PT_LOAD type</span>
  <span class="hljs-keyword">if</span> (elf_program_header[i].p_type == PT_LOAD)
  {
    <span class="hljs-built_in">fs_lseek</span>(fd, elf_program_header[i].p_offset, SEEK_SET);
    read_len=<span class="hljs-built_in">fs_read</span>(fd, (<span class="hljs-type">void</span> *)elf_program_header[i].p_vaddr, elf_program_header[i].p_memsz);
    <span class="hljs-built_in">assert</span>(read_len==elf_program_header[i].p_memsz);
    <span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span> *)(elf_program_header[i].p_vaddr + elf_program_header[i].p_filesz), <span class="hljs-number">0</span>, elf_program_header[i].p_memsz - elf_program_header[i].p_filesz);
  }
}
<span class="hljs-built_in">fs_close</span>(fd);
<span class="hljs-keyword">return</span> elf_header.e_entry;</code></pre></div></div>
<p>另外，关于如何加载新的文件也找了一些时间，在这里:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-b7kyyzlmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-b7kyyzlmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init_proc</span><span class="hljs-params">()</span> </span>{
  switch_boot_pcb();

  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"Initializing processes..."</span>);
  <span class="hljs-type">char</span> filename[] = <span class="hljs-string">"/bin/events"</span>;

  <span class="hljs-comment">// load program here</span>
  <span class="hljs-built_in">naive_uload</span>(<span class="hljs-literal">NULL</span>, filename);

}</code></pre></div></div>
<h3 id="实现完整的文件系统">实现完整的文件系统</h3>
<p>另外几个api的实现较为简单(虽然中间<code>fs_write</code>还是写错了一次)，类似于PA2中的<code>scanf</code>等实现，按照其原本的含义<code>man</code>一下对照实现即可。代码不再赘述。</p>
<p>最后，还要注册事件，还有<strong>要在<code>navy-apps/libs/libos/src/nanos.c</code>里调用系统调用接口</strong>，当时实现<code>sbrk</code>的时候说了，文件系统没有说，就忘了，还一直疑惑明明实现的没问题就是打不开文件。。。</p>
<p>单元测试成功:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211446786000_613_20230601235805595522_997_image-20230517093932147.png" srcset="/img/loading.gif" lazyload alt="image-20230517093932147">
<figcaption aria-hidden="true">image-20230517093932147</figcaption>
</figure>
<h3 id="操作系统之上的ioe">操作系统之上的IOE</h3>
<h4 id="串口">串口</h4>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-dfq7m8lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-dfq7m8lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">serial_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> len)</span> </span>{

  <span class="hljs-comment">// return 0;</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++)
  {
    _putc(((<span class="hljs-type">char</span> *)buf)[i]);
  }
  <span class="hljs-keyword">return</span> len;
}</code></pre></div></div>
<p>这时候读写文件就不需要对标准输入输出特判了，如:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-3j3q74lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-3j3q74lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (fd &lt;= <span class="hljs-number">2</span>)
{
  <span class="hljs-built_in">Log</span>(<span class="hljs-string">"ignore read from %d"</span>, fd);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre></div></div>
<h4 id="设备">设备</h4>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-4v7r22lmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-4v7r22lmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">events_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> len)</span></span>
<span class="hljs-function"></span>{
  <span class="hljs-comment">//  return 0;</span>
  <span class="hljs-type">int</span> key = <span class="hljs-built_in">read_key</span>();
  <span class="hljs-keyword">if</span> (key != _KEY_NONE) <span class="hljs-comment">// key event</span>
  {
    <span class="hljs-comment">// Log("key event");</span>
    <span class="hljs-keyword">if</span> (key &amp; <span class="hljs-number">0x8000</span>)
    {
      <span class="hljs-comment">// if (key&gt;=0x8002&amp;&amp;key&lt;=0x8004) change_gcb(key-0x8001);</span>
      <span class="hljs-built_in">sprintf</span>((<span class="hljs-type">char</span> *)buf, <span class="hljs-string">"kd %s\n"</span>, keyname[key &amp; <span class="hljs-number">0x7fff</span>]);
    }
    <span class="hljs-keyword">else</span>
    {
      <span class="hljs-built_in">sprintf</span>((<span class="hljs-type">char</span> *)buf, <span class="hljs-string">"ku %s\n"</span>, keyname[key &amp; <span class="hljs-number">0x7fff</span>]);
    }
  }
  <span class="hljs-keyword">else</span> <span class="hljs-comment">// time event</span>
  {
    <span class="hljs-comment">// if (now%1000==0) Log("time event");</span>
    <span class="hljs-built_in">sprintf</span>((<span class="hljs-type">char</span> *)buf, <span class="hljs-string">"t %d\n"</span>, <span class="hljs-built_in">uptime</span>());
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">strlen</span>((<span class="hljs-type">char</span> *)buf);
}</code></pre></div></div>
<p>这一部分一开始直接把函数参数里的<code>len</code>给返回了，就会一直报<code>receive event</code>。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211447927853_539_20230601235809798522_812_image-20230517120535802.png" srcset="/img/loading.gif" lazyload alt="image-20230517120535802">
<figcaption aria-hidden="true">image-20230517120535802</figcaption>
</figure>
<p>更新文件描述表:</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-d0ab5blmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-d0ab5blmrc2t9m"><pre><code class="hljs C++"><span class="hljs-type">static</span> Finfo file_table[] __attribute__((used)) = {
    {<span class="hljs-string">"stdin"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, invalid_read, invalid_write},
    {<span class="hljs-string">"stdout"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, invalid_read, serial_write},
    {<span class="hljs-string">"stderr"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, invalid_read, serial_write},
    {<span class="hljs-string">"/dev/events"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, events_read, invalid_write},
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"files.h"</span></span>
};</code></pre></div></div>
<p>正常工作:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211449189955_553_20230601235812963148_940_image-20230517120133366.png" srcset="/img/loading.gif" lazyload alt="image-20230517120133366">
<figcaption aria-hidden="true">image-20230517120133366</figcaption>
</figure>
<h4 id="vga">VGA</h4>
<p>这一部分指导书上说的是非常贴心，每一步该干什么都非常明确，真是非常难得。</p>
<p>其中主要是<code>fb_write</code>需要额外思索一下，其他的都是比较常规的流程。</p>
<p>另外注意VGA的一个像素占4bit。</p>
<div class="code-wrapper"><i class="fa fa-chevron-down" type="button" data-toggle="collapse" data-target="#collapse-ob7railmrc2t9m"></i><span>C++</span><div class="collapse show" id="collapse-ob7railmrc2t9m"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">fb_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> len)</span></span>
<span class="hljs-function"></span>{
	<span class="hljs-type">int</span> width=<span class="hljs-built_in">screen_width</span>();
	<span class="hljs-type">int</span> x=(offset/<span class="hljs-number">4</span>)%width,y=(offset/<span class="hljs-number">4</span>)/width;
	<span class="hljs-built_in">draw_rect</span>((<span class="hljs-type">uint32_t</span>*)buf,x,y,len/<span class="hljs-number">4</span>,<span class="hljs-number">1</span>);
	<span class="hljs-keyword">return</span> len;
}</code></pre></div></div>
<p>这一步也遇到了跑不起来的问题，不过补充了缺少的指令也成功运行起来了:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211453140815_191_20230601235817127402_182_image-20230517154453440.png" srcset="/img/loading.gif" lazyload alt="image-20230517154453440">
<figcaption aria-hidden="true">image-20230517154453440</figcaption>
</figure>
<h3 id="运行仙剑奇侠传">运行仙剑奇侠传</h3>
<p>上一个vga实现<code>movsb</code>，紧接着实现<code>movswd</code>，将<strong>编译好</strong>的<code>pal</code>放到对应文件夹中，就可以运行了。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211456492222_910_20230601235821779651_126_image-20230517164713444.png" srcset="/img/loading.gif" lazyload alt="image-20230517164713444">
<figcaption aria-hidden="true">image-20230517164713444</figcaption>
</figure>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211458145084_544_20230601235826834827_871_image-20230517164759642.png" srcset="/img/loading.gif" lazyload alt="image-20230517164759642">
<figcaption aria-hidden="true">image-20230517164759642</figcaption>
</figure>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211459457348_581_20230601235833556085_425_image-20230517170756063.png" srcset="/img/loading.gif" lazyload alt="image-20230517170756063">
<figcaption aria-hidden="true">image-20230517170756063</figcaption>
</figure>
<h3 id="展示批处理系统">展示批处理系统</h3>
<p>这是ics2019新加的一部分，实现起来非常简单，就是按照系统调用的逻辑，退出一个程序后把这个菜单程序再load进来。虽然简单，但是足够体现“操作系统的目的就是为了支持多道程序运行”的含义了。来看看我们现在都能支持哪些程序运行了。</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211500565292_239_20230601235836104923_738_image-20230517170521104.png" srcset="/img/loading.gif" lazyload alt="image-20230517170521104">
<figcaption aria-hidden="true">image-20230517170521104</figcaption>
</figure>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211502331847_228_20230601235838881129_188_image-20230517170629690.png" srcset="/img/loading.gif" lazyload alt="image-20230517170629690">
<figcaption aria-hidden="true">image-20230517170629690</figcaption>
</figure>
<h3 id="必答题-2">必答题</h3>
<h4 id="仙剑奇侠传究竟如何运行">仙剑奇侠传究竟如何运行</h4>
<h5 id="读出仙鹤信息">读出仙鹤信息</h5>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211503669868_404_20230601235842381091_613_image-20230517174652184.png" srcset="/img/loading.gif" lazyload alt="image-20230517174652184">
<figcaption aria-hidden="true">image-20230517174652184</figcaption>
</figure>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211504698736_903_20230601235844474454_763_image-20230517174823390.png" srcset="/img/loading.gif" lazyload alt="image-20230517174823390">
<figcaption aria-hidden="true">image-20230517174823390</figcaption>
</figure>
<p>可以看到打开<code>mgo.mkf</code>调用了库函数<code>fopen</code></p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211505735790_671_20230601235849337123_726_image-20230517174841335.png" srcset="/img/loading.gif" lazyload alt="image-20230517174841335">
<figcaption aria-hidden="true">image-20230517174841335</figcaption>
</figure>
<p>播放暂停时还会调用</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211506634831_668_20230601235852617171_673_image-20230517175011723.png" srcset="/img/loading.gif" lazyload alt="image-20230517175011723">
<figcaption aria-hidden="true">image-20230517175011723</figcaption>
</figure>
<p>也是直接调用库函数。</p>
<p>这一部分的过程<a target="_blank" rel="noopener" href="https://www.cnblogs.com/TKK-YLF/articles/16737509.html">网上</a>有一张图画的非常清晰，就不班门弄斧了:</p>
<figure>
<img src="https://raw.githubusercontent.com/Lunaticsky-tql/blog_articles/main/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6ics2019_PA3/20230828211507894301_491_20230601235857281415_765_image-20230517180110224.png" srcset="/img/loading.gif" lazyload alt="image-20230517180110224">
<figcaption aria-hidden="true">image-20230517180110224</figcaption>
</figure>
<h5 id="更新位置">更新位置</h5>
<p>这一部分如指导书所说，主要是<code>PAL_SplashScreen()</code>完成的。</p>
<p>首先<code>Allocate all the needed memory at once for simplification</code>，调用的是库中的<code>calloc</code>。</p>
<p>然后初始化屏幕</p>
<p><code>VIDEO_CreateCompatibleSurface -&gt; VIDEO_CreateCompatibleSizedSurface -&gt; SDL_CreateRGBSurface</code></p>
<p>读图片，获取仙鹤位置。这一部分前面已经分析了。</p>
<p>播放背景音乐。目前还没实现。</p>
<p>响应键盘事件，画屏幕</p>
<ul>
<li>背景：VIDEO_CopySurface -&gt; SDL_BlitSurface</li>
<li>仙鹤 &amp; 标题：一些特殊的方法，最后都归结为更新像素信息</li>
<li>VIDEO_UpdateScreen -&gt; (SDL_SoftStretch) / SDL_FillRect /
SDL_UpdateRect</li>
<li>SDL_UpdateRect -&gt; NDL_DrawRect -&gt; open and write
<code>/dev/fb</code></li>
</ul>
<p>最后通过<code>PAL_ProcessEvent</code>触发系统调用。这就是前面必答题中的内容了。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E4%BD%9C%E4%B8%9A/" class="category-chain-item">作业</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">#系统设计</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>南京大学ics2019_PA3</div>
      <div>http://lunaticsky-tql.github.io/posts/28172/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lunatic sky</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月29日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/44109/" title="南京大学ics2019_PA4">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">南京大学ics2019_PA4</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/45065/" title="QLion代码编辑器">
                        <span class="hidden-mobile">QLion代码编辑器</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>
              
              




              
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  




  
  









    

    
        <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
            <i class="iconfont icon-arrowup" aria-hidden="true"></i>
        </a>
    

    
        <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
</main>

<footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

</footer>

<!-- Scripts -->

  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  <script  src="https://unpkg.com/leancloud-storage@4.12.2/dist/av-live-query-min.js" ></script>

  <script defer src="/js/zan.js" ></script>

  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>




<noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
</noscript>
<!-- hexo injector body_end start -->
  <script src="/js/out_of_date.js"></script>
<!-- hexo injector body_end end --></body>
</html>
